自制虚拟蓝牙键盘控制IPad翻页
邹业盛
%%mtime(%Y-%m-%d %H:%M)
%!encoding: utf-8
%!options(xhtml): --google-analytics --disqus
%%toc


#做些准备#

最开始，是在 CPyUG 上看有人发了这么一个东西 https://github.com/lvht/btk ，当时只是觉得这东西应该很好玩，并且也很有用。大概也知道实现原理是什么样的，不过，因为我并没有需求，所以也没有继续去实践它。

过了一段时间之后，工作上的一个项目告一段落，自己的业余时间分配算是正常一点了，加上自己的一些想法，需要去学新的东西，就想到了，希望有一个可以边看文档边写代码的状态。这时，不管是把纸质书放在桌子上，还是屏幕上在文档和编辑器之间的切换，其实都是有一点不爽在里面的。

这里可能有人会说，接多个显示器。这点我以前想过，但是有一个问题没有解决（Linux下应该是可以解决的，只是我不会），就是我是用的 Fvwm 桌面环境，我有多个虚拟桌面，当我在多个虚拟桌面之间切换时（写代码时常有的事），我无法使另外一个屏幕上一直显示文档而不随着我的桌面切换而变化。

现在我的想法就是，弄另外一台设备，专门显示文档。考虑成本，及桌面的空间，弄一个平板电脑，用支架夹起来是最理想的。

一个适合显示文档的平板电脑，找了一圈，发现最好的还是 IPad （我都不明白谁会去买那些 16:9 屏幕的平板……）。所以，我在淘宝买了一个二手的 IPad3 （New IPad），价格 1200 左右（2015年4月）。

然后还有一个问题，就是支架。IPad 加上夹具，还是有些份量的。最开始在 B2C 上看一些评论，好多说夹不稳，想想也是，二三十块的东西，再加上力距因素，撑 IPad 是不太可靠。于是又四处搜索，最后在淘宝专做定位软管的店家，购得软管支架一套，价格算下来 70 多元。软管直径 14.5mm， 长度 700mm，接头，夹头全金属。背夹是塑料加两根弹簧，IPad 的宽是它的最大宽度，这时两根弹簧相当给力了，我是把 IPad 套了壳再夹上去的。

好了，现在桌子旁边挂了一个 IPad ，上面可以显示各种文档。剩下的问题就是，当文档要翻页的时候，我不想用手去点它，因为我的手在键盘上。这事，就是最开始提的在 CPyUG 中看到的那个项目要解决的问题。

简单来说，就是把手中的这块键盘（有线键盘），弄得像蓝牙键盘一样，通过蓝牙连接到 IPad 之后，实现操作的目的。

不过现在又有一个新问题了，我用的是台式机，没有蓝牙模块。这事容易解决，淘宝上一个蓝牙适配器 9 元还包邮呢。我自己最后是在 B2C 买了一个 30 多的（9 元包邮的我真怕等几天收到坏品）。

把适配器插到 USB 口上，现在，嗯，至于可以通过蓝牙跟手机传传文件什么的。

现在需要的东西都有了，只差代码了。



#方案概述#

首先需要实现的，就是做一个“蓝牙服务”出来。这样，连接上之后，键盘也好，鼠标也好，只是数据的事了。而数据怎么造，我们可以随意。

这事，对于我这种，只了解一些 7 层协议，对 Linux 系统也没有专业的认识的人来说，其实并不容易啊。

好在有现成的项目可供参考。

不过 https://github.com/lvht/btk 这个项目，因为要使用 *BlueZ 5.x* ，我系统中只有 *4.x* 的版本，而且这东西升级又很麻烦，加上项目使用的 *DBus* 那套我也不熟，所以准备参考它的代码，自己重新写。这个项目中还提到了其它的相关项目，几个项目的代码相互参照，算是把一些概念搞清楚了。


- 要让设备能被 IPad 发现，需要涉及 *服务发现* 相关的内容，还要做一个描述服务的 xml 文件。（这一步有现成工具）
- *BlueZ* 的 Python 封装，可以直接拿到 socket ，剩下的就和普通的网络编程一样了。
- 蓝牙设备的通信，会同时启 2 个连接。具体的操作命令在其中一个连接传输，另一个简单做 *echo* 就好了。
- 操作命令的具体报文编码，文档上讲的好像跟 USB 的那套是一样的，照着已有项目的代码，很容易搞定。
- Linux 系统的键盘相关事件，Python 下有 *evdev* 这个封装，很容易得到当前的按键状态。








#参考资料#

: https://github.com/lvht/btk
    用的是 *BlueZ 5.x* 和 *DBus* 实现的虚拟蓝牙键盘。

: https://github.com/lkundrak/btkbdd
    C 语言的蓝牙键盘实现。

: http://www.linuxuser.co.uk/tutorials/emulate-a-bluetooth-keyboard-with-the-raspberry-pi
    原文是使用 *RaspberryPi* 作虚拟蓝牙键盘。

: http://blog.csdn.net/chobit_s/article/details/5903223
    介绍了 Linux 系统中的键盘事件的处理。

: http://blog.csdn.net/huipengzhao/article/details/18268201
    介绍了蓝牙连接的流程还有代码示例。


