<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8" />
    <title>SQLAlchemy参考 - YS.Zou</title>
    <meta name="generator" content="http://txt2tags.org" />
    <meta name="author" content="Yesheng Zou,YS.Zou,邹业盛"/>
</head>

<body class="z" style="color: #333; font-size: 16px; letter-spacing: 0.2em; font-family: 'Microsoft YaHei','WenQuanYi Micro Hei',SimHei,tahoma,sans-serif; -webkit-font-smoothing: antialiased; margin: 0;">
    <div class="content" style="width: 900px; margin: auto; padding: 30px; box-sizing: border-box; position: relative">
        <div class="header">
            <h1 style="text-align: center; font-size: 26px; margin: 0;">SQLAlchemy参考</h1>
            <div class="user" style="margin: 20px auto; text-align: center;">
                <span>邹业盛</span>
                <span>2015-09-30 15:01 更新</span>
            </div>
        </div>

<div class="toc">

  <ol style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
  <li style="margin: 10px auto;"><a href="#toc1" style="color: #0184b7; text-decoration: none">基本流程</a>
  </li>
  <li style="margin: 10px auto;"><a href="#toc2" style="color: #0184b7; text-decoration: none">创建连接</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc3" style="color: #0184b7; text-decoration: none">2.1. Engine</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc4" style="color: #0184b7; text-decoration: none">2.2. Engine的策略</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc5" style="color: #0184b7; text-decoration: none">2.3. 各数据库实现</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc6" style="color: #0184b7; text-decoration: none">2.4. 连接池</a>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc7" style="color: #0184b7; text-decoration: none">模型使用</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc8" style="color: #0184b7; text-decoration: none">3.1. 模型定义</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc9" style="color: #0184b7; text-decoration: none">3.2. 创建</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc10" style="color: #0184b7; text-decoration: none">3.3. 查询</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc11" style="color: #0184b7; text-decoration: none">3.4. 修改</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc12" style="color: #0184b7; text-decoration: none">3.5. 删除</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc13" style="color: #0184b7; text-decoration: none">3.6. JOIN</a>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc14" style="color: #0184b7; text-decoration: none">外键和关系定义</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc15" style="color: #0184b7; text-decoration: none">4.1. 外键约束</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc16" style="color: #0184b7; text-decoration: none">4.2. 关系定义</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc17" style="color: #0184b7; text-decoration: none">4.3. 关系的查询</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc18" style="color: #0184b7; text-decoration: none">4.4. 关系的获取形式</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc19" style="color: #0184b7; text-decoration: none">4.5. 关系的表现形式</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc20" style="color: #0184b7; text-decoration: none">4.6. 多对多关系</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc21" style="color: #0184b7; text-decoration: none">4.7. Cascades 自动关系处理</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc22" style="color: #0184b7; text-decoration: none">4.8. 属性代理</a>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc23" style="color: #0184b7; text-decoration: none">会话与事务控制</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc24" style="color: #0184b7; text-decoration: none">5.1. 基本使用</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc25" style="color: #0184b7; text-decoration: none">5.2. for update</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc26" style="color: #0184b7; text-decoration: none">5.3. 事务嵌套</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc27" style="color: #0184b7; text-decoration: none">5.4. 二段式提交</a>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc28" style="color: #0184b7; text-decoration: none">字段类型</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc29" style="color: #0184b7; text-decoration: none">6.1. 基本类型</a>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc30" style="color: #0184b7; text-decoration: none">混合属性机制</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc31" style="color: #0184b7; text-decoration: none">7.1. 直接行为</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc32" style="color: #0184b7; text-decoration: none">7.2. 表达式行为</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc33" style="color: #0184b7; text-decoration: none">7.3. 应用于关系</a>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc34" style="color: #0184b7; text-decoration: none">示例: AdjacencyList, 单向链接列表</a>
  </li>
  <li style="margin: 10px auto;"><a href="#toc35" style="color: #0184b7; text-decoration: none">示例: 属性实体化建模</a>
  </li>
  </ol>

</div>

<a class="anchor" name="toc1"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">1. 基本流程</h1>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #999988; font-style: italic"># -*- coding: utf-8 -*-</span>

<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> create_engine
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.orm</span> <span style="color: #000000; font-weight: bold">import</span> sessionmaker
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> Column
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.types</span> <span style="color: #000000; font-weight: bold">import</span> String, Integer
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.ext.declarative</span> <span style="color: #000000; font-weight: bold">import</span> declarative_base

engine <span style="color: #000000; font-weight: bold">=</span> create_engine(<span style="color: #dd1144">&#39;postgresql://test@localhost:5432/test&#39;</span>)
DBSession <span style="color: #000000; font-weight: bold">=</span> sessionmaker(engine)
session <span style="color: #000000; font-weight: bold">=</span> DBSession()

BaseModel <span style="color: #000000; font-weight: bold">=</span> declarative_base()

<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(String, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    username <span style="color: #000000; font-weight: bold">=</span> Column(String, index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)

<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Session</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;session&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(String, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(String, index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    ip <span style="color: #000000; font-weight: bold">=</span> Column(String)

query <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Session, User<span style="color: #000000; font-weight: bold">.</span>username)<span style="color: #000000; font-weight: bold">.</span>join(User, User<span style="color: #000000; font-weight: bold">.</span>id <span style="color: #000000; font-weight: bold">==</span> Session<span style="color: #000000; font-weight: bold">.</span>user)
<span style="color: #000000; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> query:
    <span style="color: #000000; font-weight: bold">print</span> <span style="color: #0086B3">dir</span>(i)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc2"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">2. 创建连接</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
SQLAlchemy 的连接创建是 Lazy 的方式, 即在需要使用时才会去真正创建. 之前做的工作, 全是"定义".
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
连接的定义是在 <em style="color: #d75100; font-style: normal;">engine</em> 中做的.
</p>

<a class="anchor" name="toc3"></a>
<h2 style="font-size: 18px; margin: 30px auto;">2.1. Engine</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">engine</em> 的定义包含了三部分的内容, 一是具体数据库类型的实现, 二是连接池, 三是策略(即 <em style="color: #d75100; font-style: normal;">engine</em> 自己的实现).
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
所谓的数据库类型即是 MYSQL , Postgresql , SQLite 这些不同的数据库.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
一般创建 <em style="color: #d75100; font-style: normal;">engine</em> 是使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">create_engine</code> 方法:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">engine <span style="color: #000000; font-weight: bold">=</span> create_engine(<span style="color: #dd1144">&#39;postgresql+psycopg2://scott:tiger@localhost/mydatabase&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
参数字符串的各部分的意义:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">dialect<span style="color: #000000; font-weight: bold">+</span>driver<span style="color: #000000; font-weight: bold">:</span><span style="color: #999988; font-style: italic">//username:password@host:port/database</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对于这个字符串, SQLAlchemy 提供了工具可用于处理它:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #999988; font-style: italic"># -*- coding: utf-8 -*-</span>

<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> create_engine
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.engine.url</span> <span style="color: #000000; font-weight: bold">import</span> make_url
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.engine.url</span> <span style="color: #000000; font-weight: bold">import</span> URL

s <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;postgresql://test@localhost:5432/bbcustom&#39;</span>
url <span style="color: #000000; font-weight: bold">=</span> make_url(s)
s <span style="color: #000000; font-weight: bold">=</span> URL(drivername<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;postgresql&#39;</span>, username<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;test&#39;</span>, password<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&quot;&quot;</span>,
        host<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&quot;localhost&quot;</span>, port<span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">5432</span>, database<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&quot;bbcustom&quot;</span>)

engine <span style="color: #000000; font-weight: bold">=</span> create_engine(url)
engine <span style="color: #000000; font-weight: bold">=</span> create_engine(s)

<span style="color: #000000; font-weight: bold">print</span> engine<span style="color: #000000; font-weight: bold">.</span>execute(<span style="color: #dd1144">&#39;select id from &quot;user&quot;&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>fetchall()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">create_engine</code> 函数有很多的控制参数, 这个后面再详细说.
</p>

<a class="anchor" name="toc4"></a>
<h2 style="font-size: 18px; margin: 30px auto;">2.2. Engine的策略</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">create_engine</code> 的调用, 实际上会变成 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">strategy.create</code> 的调用. 而 <em style="color: #d75100; font-style: normal;">strategy</em> 就是 <em style="color: #d75100; font-style: normal;">engine</em> 的实现细节. <em style="color: #d75100; font-style: normal;">strategy</em> 可以在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">create_engine</code> 调用时通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">strategy</code> 参数指定, 目前官方的支持有三种:
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">plain, 默认的
</li>
<li style="margin: 10px auto;">threadlocal, 连接是线程局部的
</li>
<li style="margin: 10px auto;">mock, 所有的 SQL 语句的执行会使用指定的函数
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">mock</em> 这个实现, 会把所有的 SQL 语句的执行交给指定的函数来做, 这个函数是由 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">create_engine</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">executor</code> 参数指定:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">f</span>(sql, <span style="color: #000000; font-weight: bold">*</span>args, <span style="color: #000000; font-weight: bold">**</span>kargs):
    <span style="color: #000000; font-weight: bold">print</span> sql, args, kargs

s <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;postgresql://test@localhost:5432/bbcustom&#39;</span>
engine <span style="color: #000000; font-weight: bold">=</span> create_engine(s, strategy<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;mock&#39;</span>, executor<span style="color: #000000; font-weight: bold">=</span>f)

<span style="color: #000000; font-weight: bold">print</span> engine<span style="color: #000000; font-weight: bold">.</span>execute(<span style="color: #dd1144">&#39;select id from &quot;user&quot;&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc5"></a>
<h2 style="font-size: 18px; margin: 30px auto;">2.3. 各数据库实现</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
各数据库的实现在 SQLAlchemy 中分成了两个部分, 一是数据库的类型, 二是具体数据库中适配的客户端实现. 比如对于 Postgresql 的访问, 可以使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">psycopg2</code> , 也可以使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">pg8000</code> :
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">s <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;postgresql+psycopg2://test@localhost:5432/bbcustom&#39;</span>
s <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;postgresql+pg8000://test@localhost:5432/bbcustom&#39;</span>
engine <span style="color: #000000; font-weight: bold">=</span> create_engine(s)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
具体的适配工作, 是需要在代码中实现一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Dialect</code> 类来完成的. 官方的实现在 <em style="color: #d75100; font-style: normal;">dialects</em> 目录下.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
获取具体的 Dialect 的行为, 则是前面提到的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">URL</code> 对象的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">get_dialect</code> 方法. <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">create_engine</code> 时你单传一个字符串, SQLAlchemy 自己也会使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">make_url</code> 得到一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">URL</code> 的实例).
</p>

<a class="anchor" name="toc6"></a>
<h2 style="font-size: 18px; margin: 30px auto;">2.4. 连接池</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
SQLAlchemy 支持连接池, 在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">create_engine</code> 时添加相关参数即可使用.
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">pool_size 连接数
</li>
<li style="margin: 10px auto;">max_overflow 最多多几个连接
</li>
<li style="margin: 10px auto;">pool_recycle 连接重置周期
</li>
<li style="margin: 10px auto;">pool_timeout 连接超时时间
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
连接池效果:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #999988; font-style: italic"># -*- coding: utf-8 -*-</span>

<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> create_engine
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.engine.url</span> <span style="color: #000000; font-weight: bold">import</span> make_url
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.engine.url</span> <span style="color: #000000; font-weight: bold">import</span> URL

s <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;postgresql://test@localhost:5432/bbcustom&#39;</span>
engine <span style="color: #000000; font-weight: bold">=</span> create_engine(s, pool_size<span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">2</span>, max_overflow<span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">0</span>)


<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">threading</span> <span style="color: #000000; font-weight: bold">import</span> Thread

<span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">f</span>():
    <span style="color: #000000; font-weight: bold">print</span> engine<span style="color: #000000; font-weight: bold">.</span>execute(<span style="color: #dd1144">&#39;select pg_sleep(5)&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>fetchall()


p <span style="color: #000000; font-weight: bold">=</span> []
<span style="color: #000000; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #0086B3">range</span>(<span style="color: #009999">3</span>):
    p<span style="color: #000000; font-weight: bold">.</span>append(Thread(target<span style="color: #000000; font-weight: bold">=</span>f))

<span style="color: #000000; font-weight: bold">for</span> t <span style="color: #000000; font-weight: bold">in</span> p:
    t<span style="color: #000000; font-weight: bold">.</span>start()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
连接池的实现, 在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">create_engine</code> 调用时也可以指定:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.pool</span> <span style="color: #000000; font-weight: bold">import</span> QueuePool
engine <span style="color: #000000; font-weight: bold">=</span> create_engine(<span style="color: #dd1144">&#39;sqlite:///file.db&#39;</span>, poolclass<span style="color: #000000; font-weight: bold">=</span>QueuePool)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
还有:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.pool</span> <span style="color: #000000; font-weight: bold">import</span> NullPool
engine <span style="color: #000000; font-weight: bold">=</span> create_engine(
         <span style="color: #dd1144">&#39;postgresql+psycopg2://scott:tiger@localhost/test&#39;</span>,
          poolclass<span style="color: #000000; font-weight: bold">=</span>NullPool)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
或者仅仅是获取连接的方法:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">import</span> <span style="color: #555555">sqlalchemy.pool</span> <span style="color: #000000; font-weight: bold">as</span> <span style="color: #555555">pool</span>
<span style="color: #000000; font-weight: bold">import</span> <span style="color: #555555">psycopg2</span>

<span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">getconn</span>():
    c <span style="color: #000000; font-weight: bold">=</span> psycopg2<span style="color: #000000; font-weight: bold">.</span>connect(username<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;ed&#39;</span>, host<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;127.0.0.1&#39;</span>, dbname<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;test&#39;</span>)
    <span style="color: #999988; font-style: italic"># do things with &#39;c&#39; to set up</span>
    <span style="color: #000000; font-weight: bold">return</span> c

engine <span style="color: #000000; font-weight: bold">=</span> create_engine(<span style="color: #dd1144">&#39;postgresql+psycopg2://&#39;</span>, creator<span style="color: #000000; font-weight: bold">=</span>getconn)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
连接池可以被单独使用:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">import</span> <span style="color: #555555">sqlalchemy.pool</span> <span style="color: #000000; font-weight: bold">as</span> <span style="color: #555555">pool</span>
<span style="color: #000000; font-weight: bold">import</span> <span style="color: #555555">psycopg2</span>

<span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">getconn</span>():
    c <span style="color: #000000; font-weight: bold">=</span> psycopg2<span style="color: #000000; font-weight: bold">.</span>connect(username<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;ed&#39;</span>, host<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;127.0.0.1&#39;</span>, dbname<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;test&#39;</span>)
    <span style="color: #000000; font-weight: bold">return</span> c

mypool <span style="color: #000000; font-weight: bold">=</span> pool<span style="color: #000000; font-weight: bold">.</span>QueuePool(getconn, max_overflow<span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">10</span>, pool_size<span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">5</span>)

conn <span style="color: #000000; font-weight: bold">=</span> mypool<span style="color: #000000; font-weight: bold">.</span>connect()
cursor <span style="color: #000000; font-weight: bold">=</span> conn<span style="color: #000000; font-weight: bold">.</span>cursor()
cursor<span style="color: #000000; font-weight: bold">.</span>execute(<span style="color: #dd1144">&quot;select foo&quot;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
连接池可以被多个 engine 共享使用:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">e <span style="color: #000000; font-weight: bold">=</span> create_engine(<span style="color: #dd1144">&#39;postgresql://&#39;</span>, pool<span style="color: #000000; font-weight: bold">=</span>mypool)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc7"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">3. 模型使用</h1>

<a class="anchor" name="toc8"></a>
<h2 style="font-size: 18px; margin: 30px auto;">3.1. 模型定义</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对于 <em style="color: #d75100; font-style: normal;">Table</em> 的定义, 本来是直接的实例化调用, 通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">declarative</code> 的包装, 可以像"定义类"这样的更直观的方式来完成.
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user <span style="color: #000000; font-weight: bold">=</span> Table(<span style="color: #dd1144">&#39;user&#39;</span>, metadata,
    Column(<span style="color: #dd1144">&#39;user_id&#39;</span>, Integer, primary_key <span style="color: #000000; font-weight: bold">=</span> <span style="color: #999999">True</span>),
    Column(<span style="color: #dd1144">&#39;user_name&#39;</span>, String(<span style="color: #009999">16</span>), nullable <span style="color: #000000; font-weight: bold">=</span> <span style="color: #999999">False</span>),
    Column(<span style="color: #dd1144">&#39;email_address&#39;</span>, String(<span style="color: #009999">60</span>)),
    Column(<span style="color: #dd1144">&#39;password&#39;</span>, String(<span style="color: #009999">20</span>), nullable <span style="color: #000000; font-weight: bold">=</span> <span style="color: #999999">False</span>)
)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #999988; font-style: italic"># -*- coding: utf-8 -*-</span>

<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> create_engine
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> Column
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.types</span> <span style="color: #000000; font-weight: bold">import</span> String, Integer, CHAR, BIGINT
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.ext.declarative</span> <span style="color: #000000; font-weight: bold">import</span> declarative_base
BaseModel <span style="color: #000000; font-weight: bold">=</span> declarative_base()
Engine <span style="color: #000000; font-weight: bold">=</span> create_engine(<span style="color: #dd1144">&#39;postgresql://test@localhost:5432/test&#39;</span>, echo<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(CHAR(<span style="color: #009999">32</span>), primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    text <span style="color: #000000; font-weight: bold">=</span> Column(String, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(CHAR(<span style="color: #009999">32</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    create <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;0&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(CHAR(<span style="color: #009999">32</span>), primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    username <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    password <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)


<span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">init_db</span>():
    BaseModel<span style="color: #000000; font-weight: bold">.</span>metadata<span style="color: #000000; font-weight: bold">.</span>create_all(Engine)

<span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">drop_db</span>():
    BaseModel<span style="color: #000000; font-weight: bold">.</span>metadata<span style="color: #000000; font-weight: bold">.</span>drop_all(Engine)


<span style="color: #000000; font-weight: bold">if</span> __name__ <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;__main__&#39;</span>:
    <span style="color: #999988; font-style: italic">#init_db()</span>
    drop_db()
    <span style="color: #999988; font-style: italic">#BaseModel.metadata.tables[&#39;user&#39;].create(Engine, checkfirst=True)</span>
    <span style="color: #999988; font-style: italic">#BaseModel.metadata.tables[&#39;user&#39;].drop(Engine, checkfirst=False)</span>
    <span style="color: #000000; font-weight: bold">pass</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc9"></a>
<h2 style="font-size: 18px; margin: 30px auto;">3.2. 创建</h2>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session <span style="color: #000000; font-weight: bold">=</span> Session()
session<span style="color: #000000; font-weight: bold">.</span>add(User(<span style="color: #0086B3">id</span><span style="color: #000000; font-weight: bold">=</span>uuid<span style="color: #000000; font-weight: bold">.</span>uuid4()<span style="color: #000000; font-weight: bold">.</span>hex))
session<span style="color: #000000; font-weight: bold">.</span>add(Blog(<span style="color: #0086B3">id</span><span style="color: #000000; font-weight: bold">=</span>uuid<span style="color: #000000; font-weight: bold">.</span>uuid4()<span style="color: #000000; font-weight: bold">.</span>hex))
session<span style="color: #000000; font-weight: bold">.</span>add_all([
    User(<span style="color: #0086B3">id</span><span style="color: #000000; font-weight: bold">=</span>uuid<span style="color: #000000; font-weight: bold">.</span>uuid4()<span style="color: #000000; font-weight: bold">.</span>hex),
    Blog(<span style="color: #0086B3">id</span><span style="color: #000000; font-weight: bold">=</span>uuid<span style="color: #000000; font-weight: bold">.</span>uuid4()<span style="color: #000000; font-weight: bold">.</span>hex)
])
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
执行的顺序并不一定会和代码顺序一致, SQLAlchemy 自己会整合逻辑再执行.
</p>

<a class="anchor" name="toc10"></a>
<h2 style="font-size: 18px; margin: 30px auto;">3.3. 查询</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
SQLAlchemy 实现的查询非常强大, 写起来有一种随心所欲的感觉.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
查询的结果, 有几种不同的类型, 这个需要注意, 像是:
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">instance
</li>
<li style="margin: 10px auto;">instance of list
</li>
<li style="margin: 10px auto;">keyed tuple of list
</li>
<li style="margin: 10px auto;">value of list
</li>
</ul>

<dl style="">
<dt style="">基本查询</dt><dd style="">

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter_by(username<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;abc&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>all()
session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter(User<span style="color: #000000; font-weight: bold">.</span>username<span style="color: #000000; font-weight: bold">==</span><span style="color: #dd1144">&#39;abc&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>all()
session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>create <span style="color: #000000; font-weight: bold">&gt;=</span> <span style="color: #009999">0</span>)<span style="color: #000000; font-weight: bold">.</span>all()
session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>create <span style="color: #000000; font-weight: bold">&gt;=</span> <span style="color: #009999">0</span>)<span style="color: #000000; font-weight: bold">.</span>first()
session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>create <span style="color: #000000; font-weight: bold">&gt;=</span> <span style="color: #009999">0</span> <span style="color: #000000; font-weight: bold">|</span> Blog<span style="color: #000000; font-weight: bold">.</span>title <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;A&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>first()
session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>create <span style="color: #000000; font-weight: bold">&gt;=</span> <span style="color: #009999">0</span> <span style="color: #000000; font-weight: bold">&amp;</span> Blog<span style="color: #000000; font-weight: bold">.</span>title <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;A&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>first()
session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>create <span style="color: #000000; font-weight: bold">&gt;=</span> <span style="color: #009999">0</span>)<span style="color: #000000; font-weight: bold">.</span>offset(<span style="color: #009999">1</span>)<span style="color: #000000; font-weight: bold">.</span>limit(<span style="color: #009999">1</span>)<span style="color: #000000; font-weight: bold">.</span>scalar()
session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter(User<span style="color: #000000; font-weight: bold">.</span>username <span style="color: #000000; font-weight: bold">==</span>  <span style="color: #dd1144">&#39;abc&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>scalar()
session<span style="color: #000000; font-weight: bold">.</span>query(User<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>filter(User<span style="color: #000000; font-weight: bold">.</span>username <span style="color: #000000; font-weight: bold">==</span>  <span style="color: #dd1144">&#39;abc&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>scalar()
session<span style="color: #000000; font-weight: bold">.</span>query(Blog<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>create <span style="color: #000000; font-weight: bold">&gt;=</span> <span style="color: #009999">0</span>)<span style="color: #000000; font-weight: bold">.</span>all()
session<span style="color: #000000; font-weight: bold">.</span>query(Blog<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>create <span style="color: #000000; font-weight: bold">&gt;=</span> <span style="color: #009999">0</span>)<span style="color: #000000; font-weight: bold">.</span>all()[<span style="color: #009999">0</span>]<span style="color: #000000; font-weight: bold">.</span>id
<span style="color: #0086B3">dict</span>(session<span style="color: #000000; font-weight: bold">.</span>query(Blog<span style="color: #000000; font-weight: bold">.</span>id, Blog<span style="color: #000000; font-weight: bold">.</span>title)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>create <span style="color: #000000; font-weight: bold">&gt;=</span> <span style="color: #009999">0</span>)<span style="color: #000000; font-weight: bold">.</span>all())
session<span style="color: #000000; font-weight: bold">.</span>query(Blog<span style="color: #000000; font-weight: bold">.</span>id, Blog<span style="color: #000000; font-weight: bold">.</span>title)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>create <span style="color: #000000; font-weight: bold">&gt;=</span> <span style="color: #009999">0</span>)<span style="color: #000000; font-weight: bold">.</span>first()<span style="color: #000000; font-weight: bold">.</span>title
session<span style="color: #000000; font-weight: bold">.</span>query(User<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>order_by(<span style="color: #dd1144">&#39;id desc&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>all()
session<span style="color: #000000; font-weight: bold">.</span>query(User<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>order_by(<span style="color: #dd1144">&#39;id&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>first()
session<span style="color: #000000; font-weight: bold">.</span>query(User<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>order_by(User<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>first()
session<span style="color: #000000; font-weight: bold">.</span>query(User<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>order_by(<span style="color: #000000; font-weight: bold">-</span>User<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>first()
session<span style="color: #000000; font-weight: bold">.</span>query(<span style="color: #dd1144">&#39;id&#39;</span>, <span style="color: #dd1144">&#39;username&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>select_from(User)<span style="color: #000000; font-weight: bold">.</span>all()
session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>get(<span style="color: #dd1144">&#39;16e19a64d5874c308421e1a835b01c69&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style="">多表查询</dt><dd style="">

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session<span style="color: #000000; font-weight: bold">.</span>query(Blog, User)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>user <span style="color: #000000; font-weight: bold">==</span> User<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>first()<span style="color: #000000; font-weight: bold">.</span>User<span style="color: #000000; font-weight: bold">.</span>username
session<span style="color: #000000; font-weight: bold">.</span>query(Blog, User<span style="color: #000000; font-weight: bold">.</span>id, User<span style="color: #000000; font-weight: bold">.</span>username)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>user <span style="color: #000000; font-weight: bold">==</span> User<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>first()<span style="color: #000000; font-weight: bold">.</span>id
session<span style="color: #000000; font-weight: bold">.</span>query(Blog<span style="color: #000000; font-weight: bold">.</span>id,
              User<span style="color: #000000; font-weight: bold">.</span>id,
              User<span style="color: #000000; font-weight: bold">.</span>username)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>user <span style="color: #000000; font-weight: bold">==</span> User<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>first()<span style="color: #000000; font-weight: bold">.</span>keys()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style="">条件查询</dt><dd style="">

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> or_, not_

session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter(or_(User<span style="color: #000000; font-weight: bold">.</span>id <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;&#39;</span>,
                               User<span style="color: #000000; font-weight: bold">.</span>id <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;16e19a64d5874c308421e1a835b01c69&#39;</span>))<span style="color: #000000; font-weight: bold">.</span>all()
session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter(not_(User<span style="color: #000000; font-weight: bold">.</span>id <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;16e19a64d5874c308421e1a835b01c69&#39;</span>))<span style="color: #000000; font-weight: bold">.</span>all()
session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter(User<span style="color: #000000; font-weight: bold">.</span>id<span style="color: #000000; font-weight: bold">.</span>in_([<span style="color: #dd1144">&#39;16e19a64d5874c308421e1a835b01c69&#39;</span>]))<span style="color: #000000; font-weight: bold">.</span>all()
session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter(User<span style="color: #000000; font-weight: bold">.</span>id<span style="color: #000000; font-weight: bold">.</span>like(<span style="color: #dd1144">&#39;16e19a%&#39;</span>))<span style="color: #000000; font-weight: bold">.</span>all()
session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter(User<span style="color: #000000; font-weight: bold">.</span>id<span style="color: #000000; font-weight: bold">.</span>startswith(<span style="color: #dd1144">&#39;16e19a&#39;</span>))<span style="color: #000000; font-weight: bold">.</span>all()
<span style="color: #0086B3">dir</span>(User<span style="color: #000000; font-weight: bold">.</span>id)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style="">函数</dt><dd style="">

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> func
session<span style="color: #000000; font-weight: bold">.</span>query(func<span style="color: #000000; font-weight: bold">.</span>count(<span style="color: #dd1144">&#39;1&#39;</span>))<span style="color: #000000; font-weight: bold">.</span>select_from(User)<span style="color: #000000; font-weight: bold">.</span>scalar()
session<span style="color: #000000; font-weight: bold">.</span>query(func<span style="color: #000000; font-weight: bold">.</span>count(<span style="color: #dd1144">&#39;1&#39;</span>), func<span style="color: #000000; font-weight: bold">.</span>max(User<span style="color: #000000; font-weight: bold">.</span>username))<span style="color: #000000; font-weight: bold">.</span>select_from(User)<span style="color: #000000; font-weight: bold">.</span>first()
session<span style="color: #000000; font-weight: bold">.</span>query(func<span style="color: #000000; font-weight: bold">.</span>count(<span style="color: #dd1144">&#39;1&#39;</span>))<span style="color: #000000; font-weight: bold">.</span>select_from(User)<span style="color: #000000; font-weight: bold">.</span>scalar()
session<span style="color: #000000; font-weight: bold">.</span>query(func<span style="color: #000000; font-weight: bold">.</span>md5(User<span style="color: #000000; font-weight: bold">.</span>username))<span style="color: #000000; font-weight: bold">.</span>select_from(User)<span style="color: #000000; font-weight: bold">.</span>all()
session<span style="color: #000000; font-weight: bold">.</span>query(func<span style="color: #000000; font-weight: bold">.</span>current_timestamp())<span style="color: #000000; font-weight: bold">.</span>scalar()
session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>count()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

</dd>
</dl>

<a class="anchor" name="toc11"></a>
<h2 style="font-size: 18px; margin: 30px auto;">3.4. 修改</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
还是通常的两种方式:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter(User<span style="color: #000000; font-weight: bold">.</span>username <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;abc&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>update({<span style="color: #dd1144">&#39;name&#39;</span>: <span style="color: #dd1144">&#39;123&#39;</span>})
session<span style="color: #000000; font-weight: bold">.</span>commit()

user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter_by(username<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;abc&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>scalar()
user<span style="color: #000000; font-weight: bold">.</span>name <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;223&#39;</span>
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如果涉及对属性原值的引用, 则要考虑 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">synchronize_session</code> 这个参数.
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">'evaluate'</code> 默认值, 会同时修改当前 session 中的对象属性.
</li>
<li style="margin: 10px auto;"><code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">'fetch'</code> 修改前, 会先通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">select</code> 查询条目的值.
</li>
<li style="margin: 10px auto;"><code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">False</code> 不修改当前 session 中的对象属性.
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在默认情况下, 因为会有修改当前会话中的对象属性, 所以如果语句中有 SQL 函数, 或者"原值引用", 那是无法完成的操作, 自然也会报错, 比如:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> func
session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>update({User<span style="color: #000000; font-weight: bold">.</span>name: func<span style="color: #000000; font-weight: bold">.</span>trim(<span style="color: #dd1144">&#39;123 &#39;</span>)})
session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>update({User<span style="color: #000000; font-weight: bold">.</span>name: User<span style="color: #000000; font-weight: bold">.</span>name <span style="color: #000000; font-weight: bold">+</span> <span style="color: #dd1144">&#39;x&#39;</span>})
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这种情况下, 就不能要求 SQLAlchemy 修改当前 session 的对象属性了, 而是直接进行数据库的交互, 不管当前会话值:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>update({User<span style="color: #000000; font-weight: bold">.</span>name: User<span style="color: #000000; font-weight: bold">.</span>name <span style="color: #000000; font-weight: bold">+</span> <span style="color: #dd1144">&#39;x&#39;</span>}, synchronize_session<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
是否修改当前会话的对象属性, 涉及到当前会话的状态. 如果当前会话过期, 那么在获取相关对象的属性值时, SQLAlchemy 会自动作一次数据库查询, 以便获取正确的值:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter_by(username<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;abc&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>scalar()
<span style="color: #000000; font-weight: bold">print</span> user<span style="color: #000000; font-weight: bold">.</span>name
session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>update({User<span style="color: #000000; font-weight: bold">.</span>name: <span style="color: #dd1144">&#39;new&#39;</span>}, synchronize_session<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
<span style="color: #000000; font-weight: bold">print</span> user<span style="color: #000000; font-weight: bold">.</span>name
session<span style="color: #000000; font-weight: bold">.</span>commit()
<span style="color: #000000; font-weight: bold">print</span> user<span style="color: #000000; font-weight: bold">.</span>name
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
执行了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">update</code> 之后, 虽然相关对象的实际的属性值已变更, 但是当前会话中的对象属性值并没有改变. 直到 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">session.commit()</code> 之后, 当前会话变成"过期"状态, 再次获取 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">user.name</code> 时, SQLAlchemy 通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">user</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">id</code> 属性, 重新去数据库查询了新值. (如果 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">user</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">id</code> 变了呢? 那就会出事了啊.)
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">synchronize_session</code> 设置成 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">'fetch'</code> 不会有这样的问题, 因为在做 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">update</code> 时已经修改了当前会话中的对象了.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
不管 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">synchronize_session</code> 的行为如何, <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">commit</code> 之后 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">session</code> 都会过期, 再次获取相关对象值时, 都会重新作一次查询.
</p>

<a class="anchor" name="toc12"></a>
<h2 style="font-size: 18px; margin: 30px auto;">3.5. 删除</h2>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter_by(username<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;abc&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>delete()

user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter_by(username<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;abc&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>first()
session<span style="color: #000000; font-weight: bold">.</span>delete(user)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
删除同样有像修改一样的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">synchronize_session</code> 参数的问题, 影响当前会话的状态.
</p>

<a class="anchor" name="toc13"></a>
<h2 style="font-size: 18px; margin: 30px auto;">3.6. JOIN</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
SQLAlchemy 可以很直观地作 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">join</code> 的支持:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">r <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Blog, User)<span style="color: #000000; font-weight: bold">.</span>join(User, Blog<span style="color: #000000; font-weight: bold">.</span>user <span style="color: #000000; font-weight: bold">==</span> User<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>all()
<span style="color: #000000; font-weight: bold">for</span> blog, user <span style="color: #000000; font-weight: bold">in</span> r:
    <span style="color: #000000; font-weight: bold">print</span> blog<span style="color: #000000; font-weight: bold">.</span>id, blog<span style="color: #000000; font-weight: bold">.</span>user, user<span style="color: #000000; font-weight: bold">.</span>id


r <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Blog, User<span style="color: #000000; font-weight: bold">.</span>name, User<span style="color: #000000; font-weight: bold">.</span>username)<span style="color: #000000; font-weight: bold">.</span>join(User, Blog<span style="color: #000000; font-weight: bold">.</span>user <span style="color: #000000; font-weight: bold">==</span> User<span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>all()
<span style="color: #000000; font-weight: bold">print</span> r
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc14"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">4. 外键和关系定义</h1>

<a class="anchor" name="toc15"></a>
<h2 style="font-size: 18px; margin: 30px auto;">4.1. 外键约束</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
使用 <em style="color: #d75100; font-style: normal;">ForeignKey</em> 来定义一个外键约定:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> Column, ForeignKey
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.types</span> <span style="color: #000000; font-weight: bold">import</span> String, Integer, CHAR, BIGINT

<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    text <span style="color: #000000; font-weight: bold">=</span> Column(String, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    create <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;0&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    username <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    password <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
创建时:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session <span style="color: #000000; font-weight: bold">=</span> Session()
user <span style="color: #000000; font-weight: bold">=</span> User(name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;first&#39;</span>, username<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">u&#39;新的&#39;</span>)
session<span style="color: #000000; font-weight: bold">.</span>add(user)
session<span style="color: #000000; font-weight: bold">.</span>flush()
blog <span style="color: #000000; font-weight: bold">=</span> Blog(title<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">u&#39;第一个&#39;</span>, user<span style="color: #000000; font-weight: bold">=</span>user<span style="color: #000000; font-weight: bold">.</span>id)
session<span style="color: #000000; font-weight: bold">.</span>add(blog)
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">session.flush()</code> 是进行数据库交互, 但是事务并没有提交. 进行数据库交互之后, <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">user.id</code> 才有值.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
定义了外键, 对查询来说, 并没有影响. 外键只是单纯的一条约束而已. 当然, 可以在外键上定义一些关联的事件操作, 比如当外键条目被删除时, 字段置成 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">null</code> , 或者关联条目也被删除等.
</p>

<a class="anchor" name="toc16"></a>
<h2 style="font-size: 18px; margin: 30px auto;">4.2. 关系定义</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
要定义关系, 必有使用 <em style="color: #d75100; font-style: normal;">ForeignKey</em> 约束. 当然, 这里说的只是在定义模型时必有要有, 至于数据库中是否真有外键约定, 这并不重要.
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> Column, ForeignKey
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.types</span> <span style="color: #000000; font-weight: bold">import</span> String, Integer, CHAR, BIGINT
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.ext.declarative</span> <span style="color: #000000; font-weight: bold">import</span> declarative_base
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.orm</span> <span style="color: #000000; font-weight: bold">import</span> sessionmaker, relationship


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    create <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;0&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)

    user_obj <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;User&#39;</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)

    blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, order_by<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;Blog.create&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
关系只是 SQLAlchemy 提供的工具, 与数据库无关, 所以任何时候添加都是可以的.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面的 <em style="color: #d75100; font-style: normal;">User-Blog</em> 是一个"一对多"关系, 通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Blog</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">user</code> 这个 <em style="color: #d75100; font-style: normal;">ForeignKey</em> , SQLAlchemy 可以自动处理关系的定义. 在查询时, 返回的结果自然也是, 一个是列表, 一个是单个对象:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session <span style="color: #000000; font-weight: bold">=</span> Session()
<span style="color: #000000; font-weight: bold">print</span> session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>get(<span style="color: #009999">1</span>)<span style="color: #000000; font-weight: bold">.</span>user_obj
<span style="color: #000000; font-weight: bold">print</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>get(<span style="color: #009999">1</span>)<span style="color: #000000; font-weight: bold">.</span>blog_list
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这种关系的定义, 并不影响查询并获取对象的行为, 不会添加额外的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">join</code> 操作. 在对象上取一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">user_obj</code> 或者取 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">blog_list</code> 都是发生了一个新的查询操作.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面的关系定义, 对应的属性是实际查询出的实例列表, 当条目数多的时候, 这样可能会有问题. 比如用户名下有成千上万的文章, 一次全取出就太暴力了. 关系对应的属性可以定义成一个 <em style="color: #d75100; font-style: normal;">Query</em> :
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)

    blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, order_by<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;Blog.create&#39;</span>, lazy<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&quot;dynamic&quot;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这样在获取实例时就可以自由控制了:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>get(<span style="color: #009999">1</span>)<span style="color: #000000; font-weight: bold">.</span>blog_list<span style="color: #000000; font-weight: bold">.</span>all()
session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>get(<span style="color: #009999">1</span>)<span style="color: #000000; font-weight: bold">.</span>blog_list<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>title <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;abc&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>first()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc17"></a>
<h2 style="font-size: 18px; margin: 30px auto;">4.3. 关系的查询</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
关系定义之后, 除了在查询时会有自动关联的效果, 在作查询时, 也可以对定义的关系做操作:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(Integer, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)

    user_obj <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;User&#39;</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)

    blogs <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对于 <em style="color: #d75100; font-style: normal;">一对多</em> 的关系, 使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">any()</code> 函数查询:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter(User<span style="color: #000000; font-weight: bold">.</span>blogs<span style="color: #000000; font-weight: bold">.</span>any(Blog<span style="color: #000000; font-weight: bold">.</span>title <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">u&#39;A&#39;</span>))<span style="color: #000000; font-weight: bold">.</span>first()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
SQLAlchemy 会使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">exists</code> 条件, 类似于:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">SELECT</span> <span style="color: #000000; font-weight: bold">*</span>
<span style="color: #000000; font-weight: bold">FROM</span> <span style="color: #000000; font-weight: bold">user</span>
<span style="color: #000000; font-weight: bold">WHERE</span> <span style="color: #000000; font-weight: bold">EXISTS</span>
    (<span style="color: #000000; font-weight: bold">SELECT</span> <span style="color: #009999">1</span>
     <span style="color: #000000; font-weight: bold">FROM</span> blog
     <span style="color: #000000; font-weight: bold">WHERE</span> <span style="color: #000000; font-weight: bold">user</span>.id <span style="color: #000000; font-weight: bold">=</span> blog.<span style="color: #000000; font-weight: bold">user</span> <span style="color: #000000; font-weight: bold">AND</span> blog.title <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">?</span>)
 <span style="color: #000000; font-weight: bold">LIMIT</span> <span style="color: #000000; font-weight: bold">?</span> <span style="color: #000000; font-weight: bold">OFFSET</span> <span style="color: #000000; font-weight: bold">?</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
反之, 如果是 <em style="color: #d75100; font-style: normal;">多对一</em> 的关系, 则使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">has()</code> 函数查询:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">blog <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>user_obj<span style="color: #000000; font-weight: bold">.</span>has(User<span style="color: #000000; font-weight: bold">.</span>name <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">u&#39;XX&#39;</span>))<span style="color: #000000; font-weight: bold">.</span>first()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
最后的 SQL 语句都是一样的.
</p>

<a class="anchor" name="toc18"></a>
<h2 style="font-size: 18px; margin: 30px auto;">4.4. 关系的获取形式</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
前面介绍的关系定义中, 提到了两种关系的获取形式, 一种是:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user_obj <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;User&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这种是在对象上获取关系对象时, 再去查询.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
另一种是:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, lazy<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&quot;dynamic&quot;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这种的结果, 是在对象上获取关系对象时, 只返回 <em style="color: #d75100; font-style: normal;">Query</em> , 而查询的细节由人为来控制.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
总的来说, 关系的获取分成两种, <em style="color: #d75100; font-style: normal;">Lazy</em> 或 <em style="color: #d75100; font-style: normal;">Eager</em> . 在直接查询层面, 上面两种都属于 <em style="color: #d75100; font-style: normal;">Lazy</em> 的方式, 而 <em style="color: #d75100; font-style: normal;">Eager</em> 的一种, 就是在获取对象时的查询语句, 是直接带 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">join</code> 的, 这样关系对象的数据在一个查询语句中就直接获取到了:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)

    user_obj <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;User&#39;</span>, lazy<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;joined&#39;</span>, cascade<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;all&#39;</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这样在查询时:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">blog <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>first()
<span style="color: #000000; font-weight: bold">print</span> blog<span style="color: #000000; font-weight: bold">.</span>user_obj
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
便会多出 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">LEFT OUTER JOIN</code> 的语句, 结果中直接获取到对应的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">User</code> 实例对象.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
也可以把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">joined</code> 换成子查询, <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">subquery</code> :
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)

    blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, cascade<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;all&#39;</span>, lazy<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;subquery&#39;</span>)


<span style="color: #000000; font-weight: bold">if</span> __name__ <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;__main__&#39;</span>:

    session <span style="color: #000000; font-weight: bold">=</span> Session()
    user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>first()
    session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
子查询会用到临时表.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面定义的:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, lazy<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&quot;dynamic&quot;</span>)
user_obj <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;User&#39;</span>, lazy<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;joined&#39;</span>)
blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, lazy<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;subquery&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
都算是一种默认方式. 在具体使用查询时, 还可以通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">options()</code> 方法定义关联的获取方式:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.orm</span> <span style="color: #000000; font-weight: bold">import</span> lazyload, joinedload, subqueryload
user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>options(lazyload(<span style="color: #dd1144">&#39;blog_list&#39;</span>))<span style="color: #000000; font-weight: bold">.</span>first()
<span style="color: #000000; font-weight: bold">print</span> user<span style="color: #000000; font-weight: bold">.</span>blog_list
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
更多的用法:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session<span style="color: #000000; font-weight: bold">.</span>query(Parent)<span style="color: #000000; font-weight: bold">.</span>options(
    joinedload(<span style="color: #dd1144">&#39;foo&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>joinedload(<span style="color: #dd1144">&#39;bar&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>joinedload(<span style="color: #dd1144">&#39;bat&#39;</span>)
    )<span style="color: #000000; font-weight: bold">.</span>all()

session<span style="color: #000000; font-weight: bold">.</span>query(A)<span style="color: #000000; font-weight: bold">.</span>options(
    defaultload(<span style="color: #dd1144">&quot;atob&quot;</span>)<span style="color: #000000; font-weight: bold">.</span>joinedload(<span style="color: #dd1144">&quot;btoc&quot;</span>)
    )<span style="color: #000000; font-weight: bold">.</span>all()

session<span style="color: #000000; font-weight: bold">.</span>query(MyClass)<span style="color: #000000; font-weight: bold">.</span>options(lazyload(<span style="color: #dd1144">&#39;*&#39;</span>))

session<span style="color: #000000; font-weight: bold">.</span>query(MyClass)<span style="color: #000000; font-weight: bold">.</span>options(
    lazyload(<span style="color: #dd1144">&#39;*&#39;</span>), joinedload(MyClass<span style="color: #000000; font-weight: bold">.</span>widget)
    )

session<span style="color: #000000; font-weight: bold">.</span>query(User, Address)<span style="color: #000000; font-weight: bold">.</span>options(Load(Address)<span style="color: #000000; font-weight: bold">.</span>lazyload(<span style="color: #dd1144">&#39;*&#39;</span>))
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如果关联的定义之前是 <em style="color: #d75100; font-style: normal;">Lazy</em> 的, 但是实际使用中, 希望在手工 <em style="color: #d75100; font-style: normal;">join</em> 之后, 把关联对象直接包含进结果实例, 可以使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">contains_eager()</code> 来包装一下:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.orm</span> <span style="color: #000000; font-weight: bold">import</span> contains_eager

blog <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>join(Blog<span style="color: #000000; font-weight: bold">.</span>user_obj)<span style="color: #a61717; background-color: #e3d2d2">\</span>
              <span style="color: #000000; font-weight: bold">.</span>options(contains_eager(Blog<span style="color: #000000; font-weight: bold">.</span>user_obj))<span style="color: #000000; font-weight: bold">.</span>first()
<span style="color: #000000; font-weight: bold">print</span> blog<span style="color: #000000; font-weight: bold">.</span>user_obj
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc19"></a>
<h2 style="font-size: 18px; margin: 30px auto;">4.5. 关系的表现形式</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
关系在对象属性中的表现, 默认是列表, 但是, 这不是唯一的形式. 根据需要, 可以作成 dictionary , set 或者其它你需要的对象.
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(Integer, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)

    user_obj <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;User&#39;</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)

    blogs <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对于上面的两个模型:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>first()
<span style="color: #000000; font-weight: bold">print</span> user<span style="color: #000000; font-weight: bold">.</span>blogs
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
现在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">user.blogs</code> 是一个列表. 我们可以在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">relationship()</code> 调用时通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">collection_class</code> 参数指定一个类, 来重新定义关系的表现形式:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user <span style="color: #000000; font-weight: bold">=</span> User(name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">u&#39;XX&#39;</span>)
session<span style="color: #000000; font-weight: bold">.</span>add_all([Blog(title<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">u&#39;A&#39;</span>, user_obj<span style="color: #000000; font-weight: bold">=</span>user), Blog(title<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">u&#39;B&#39;</span>, user_obj<span style="color: #000000; font-weight: bold">=</span>user)])
session<span style="color: #000000; font-weight: bold">.</span>commit()

user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>first()
<span style="color: #000000; font-weight: bold">print</span> user<span style="color: #000000; font-weight: bold">.</span>blogs
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<dl style="">
<dt style=""><em style="color: #d75100; font-style: normal;">set</em> , 集合:</dt><dd style="">
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">blogs <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, collection_class<span style="color: #000000; font-weight: bold">=</span><span style="color: #0086B3">set</span>)

<span style="color: #999988; font-style: italic">#InstrumentedSet([&lt;__main__.Blog object at 0x1a58710&gt;, &lt;__main__.Blog object at 0x1a587d0&gt;])</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">attribute_mapped_collection</em> , 字典, 键值从属性取:</dt><dd style="">
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.orm.collections</span> <span style="color: #000000; font-weight: bold">import</span> attribute_mapped_collection

blogs <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, collection_class<span style="color: #000000; font-weight: bold">=</span>attribute_mapped_collection(<span style="color: #dd1144">&#39;title&#39;</span>))

<span style="color: #999988; font-style: italic">#{u&#39;A&#39;: &lt;__main__.Blog object at 0x20ed810&gt;, u&#39;B&#39;: &lt;__main__.Blog object at 0x20ed8d0&gt;}</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
如果 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">title</code> 重复的话, 结果会覆盖.
</dd>
</dl>

<dl style="">
<dt style=""><em style="color: #d75100; font-style: normal;">mapped_collection</em> , 字典, 键值自定义:</dt><dd style="">
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.orm.collections</span> <span style="color: #000000; font-weight: bold">import</span> mapped_collection

blogs <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, collection_class<span style="color: #000000; font-weight: bold">=</span>mapped_collection(<span style="color: #000000; font-weight: bold">lambda</span> blog: blog<span style="color: #000000; font-weight: bold">.</span>title<span style="color: #000000; font-weight: bold">.</span>lower()))

<span style="color: #999988; font-style: italic">#{u&#39;a&#39;: &lt;__main__.Blog object at 0x1de4890&gt;, u&#39;b&#39;: &lt;__main__.Blog object at 0x1de4950&gt;}</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

</dd>
</dl>

<a class="anchor" name="toc20"></a>
<h2 style="font-size: 18px; margin: 30px auto;">4.6. 多对多关系</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
先考虑典型的多对多关系结构:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)

    tag_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Tag&#39;</span>)
    tag_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;BlogAndTag&#39;</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Tag</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;tag&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">16</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">BlogAndTag</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog_and_tag&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    blog <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, ForeignKey(<span style="color: #dd1144">&#39;blog.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    tag <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, ForeignKey(<span style="color: #dd1144">&#39;tag.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    create <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;0&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Blog</code> 中的:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">tag_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Tag&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
显示是错误的, 因为在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Tag</code> 中并没有外键. 而:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">tag_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;BlogAndTag&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这样虽然正确, 但是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">tag_list</code> 的关系只是到达 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">BlogAndTag</code> 这一层, 并没有到达我们需要的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Tag</code> .
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这种情况下, 一个多对多关系是有三张表来表示的, 在定义 <em style="color: #d75100; font-style: normal;">relationship</em> 时, 就需要一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">secondary</code> 参数来指明关系表:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)

    tag_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Tag&#39;</span>, secondary<span style="color: #000000; font-weight: bold">=lambda</span>: BlogAndTag<span style="color: #000000; font-weight: bold">.</span>__table__)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Tag</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;tag&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">16</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">BlogAndTag</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog_and_tag&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    blog <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, ForeignKey(<span style="color: #dd1144">&#39;blog.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    tag <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, ForeignKey(<span style="color: #dd1144">&#39;tag.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    create <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;0&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这样, 在操作时可以直接获取到对应的实例列表:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">blog <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>title <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;a&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>one()
<span style="color: #000000; font-weight: bold">print</span> blog<span style="color: #000000; font-weight: bold">.</span>tag_list
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
访问 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">tag_list</code> 时, SQLAlchemy 做的是一个普通的多表查询.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">tag_list</code> 属性同时支持赋值操作:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session <span style="color: #000000; font-weight: bold">=</span> Session()
blog <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>title <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;a&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>one()
blog<span style="color: #000000; font-weight: bold">.</span>tag_list <span style="color: #000000; font-weight: bold">=</span> [Tag(name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;t1&#39;</span>)]
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
提交时, SQLAlchemy 总是会创建 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Tag</code> , 及对应的关系 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">BlogAndTag</code> .
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
而如果是:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session <span style="color: #000000; font-weight: bold">=</span> Session()
blog <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>title <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;a&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>one()
blog<span style="color: #000000; font-weight: bold">.</span>tag_list <span style="color: #000000; font-weight: bold">=</span> []
session<span style="color: #000000; font-weight: bold">.</span>commit()

tag <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Tag)<span style="color: #000000; font-weight: bold">.</span>filter(Tag<span style="color: #000000; font-weight: bold">.</span>name <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;x&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>one()
blog<span style="color: #000000; font-weight: bold">.</span>tag_list<span style="color: #000000; font-weight: bold">.</span>remove(tag)
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
那么 SQLAlchemy 只会删除对应的关系 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">BlogAndTag</code> , 不会删除实体 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Tag</code> .
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如果你直接删除实体, 那么对应的关系是不会自动删除的:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session <span style="color: #000000; font-weight: bold">=</span> Session()
blog <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>title <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;a&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>one()
tag <span style="color: #000000; font-weight: bold">=</span> Tag(name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;ok&#39;</span>)
blog<span style="color: #000000; font-weight: bold">.</span>tag_list <span style="color: #000000; font-weight: bold">=</span> [tag]
session<span style="color: #000000; font-weight: bold">.</span>commit()

tag <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Tag)<span style="color: #000000; font-weight: bold">.</span>filter(Tag<span style="color: #000000; font-weight: bold">.</span>name <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;ok&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>one()
session<span style="color: #000000; font-weight: bold">.</span>delete(tag)
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc21"></a>
<h2 style="font-size: 18px; margin: 30px auto;">4.7. Cascades 自动关系处理</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
前面提到的, 当操作关系, 实体时, 与其相关联的关系, 实体是否会被自动处理的问题, 在 SQLAlchemy 中是通过 <em style="color: #d75100; font-style: normal;">Cascades</em> 机制来定义和解决的. ( <em style="color: #d75100; font-style: normal;">Cascades</em> 这个词是来源于 <em style="color: #d75100; font-style: normal;">Hibernate</em> .)
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">cascade</code> 是一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">relationship</code> 的参数, 其值是逗号分割的多个字符串, 以表示不同的行为. 默认值是 " <em style="color: #d75100; font-style: normal;">save-update</em>, <em style="color: #d75100; font-style: normal;">merge</em>" , 稍后会介绍每个词项的作用.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里的所有规则介绍, 只涉及从 <em style="color: #d75100; font-style: normal;">Parent</em> 到 <em style="color: #d75100; font-style: normal;">Child</em> , <em style="color: #d75100; font-style: normal;">Parent</em> 即定义 <em style="color: #d75100; font-style: normal;">relationship</em>的类. 不涉及 <em style="color: #d75100; font-style: normal;">backref</em> .
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">cascade</code> 所有的可选字符串项是:
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">all</em> , 所有操作都会自动处理到关联对象上.
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">save-update</em> , 关联对象自动添加到会话.
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">delete</em> , 关联对象自动从会话中删除.
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">delete-orphan</em> , 属性中去掉关联对象, 则会话中会自动删除关联对象.
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">merge</em> , <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">session.merge()</code> 时会处理关联对象.
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">refresh-expire</em> , <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">session.expire()</code> 时会处理关联对象.
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">expunge</em> , <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">session.expunge()</code> 时会处理关联对象.
</li>
</ul>

<dl style="">
<dt style=""><em style="color: #d75100; font-style: normal;">save-update</em></dt><dd style="">
    当一个对象被添加进 session 后, 此对象标记为 <em style="color: #d75100; font-style: normal;">save-update</em> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">relationship</code> 关系对象也会同时添加进这个 session .
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)

    blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, cascade<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)
    blog_list_auto <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, cascade<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;save-update&#39;</span>)


<span style="color: #000000; font-weight: bold">if</span> __name__ <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;__main__&#39;</span>:

    session <span style="color: #000000; font-weight: bold">=</span> Session()

    user <span style="color: #000000; font-weight: bold">=</span> User(name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">u&#39;哈哈&#39;</span>)
    blog <span style="color: #000000; font-weight: bold">=</span> Blog(title<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">u&#39;第一个&#39;</span>)
    user<span style="color: #000000; font-weight: bold">.</span>blog_list <span style="color: #000000; font-weight: bold">=</span> [blog]
    <span style="color: #999988; font-style: italic">#user.blog_list_auto = [blog]</span>
    session<span style="color: #000000; font-weight: bold">.</span>add(user)
    <span style="color: #000000; font-weight: bold">print</span> blog <span style="color: #000000; font-weight: bold">in</span> session
    session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">delete</em></dt><dd style="">
    当一个对象在 session 中被标记为删除时, 其属性中 <em style="color: #d75100; font-style: normal;">relationship</em> 关联的对象也会被标记成删除, 否则, 关联对象中的对应外键字段会被改成 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">NULL</code> , 不能为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">NULL</code> 则报错.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)

    blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, cascade<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;save-update, delete&#39;</span>)


<span style="color: #000000; font-weight: bold">if</span> __name__ <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;__main__&#39;</span>:
    session <span style="color: #000000; font-weight: bold">=</span> Session()

    <span style="color: #999988; font-style: italic">#user = User(name=u&#39;用户&#39;)</span>
    <span style="color: #999988; font-style: italic">#user.blog_list = [Blog(title=u&#39;哈哈&#39;)]</span>
    <span style="color: #999988; font-style: italic">#session.add(user)</span>
    user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>first()
    session<span style="color: #000000; font-weight: bold">.</span>delete(user)
    session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">delete-orphan</em></dt><dd style="">
    当 <em style="color: #d75100; font-style: normal;">relationship</em> 属性变化时, 被 "去掉" 的对象会被自动删除. 比如之前是:
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user<span style="color: #000000; font-weight: bold">.</span>blog_list <span style="color: #000000; font-weight: bold">=</span> [blog, blog2]
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
现在变成:
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user<span style="color: #000000; font-weight: bold">.</span>blog_list <span style="color: #000000; font-weight: bold">=</span> [blog2]
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
那么 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">blog</code> 这个关联实体是会自动删除的.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
这各机制只适用于 "一对多" 的关系中, "多对多" 和反过来的 "多对一" 都不适用. 在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">relationship</code> 定义时, 可以添加  <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">single_parent = True</code> 参数来强制约束. 当然, 在实现上 SQLAlchemy 是会先查出所有关联实体, 然后计算差集确认哪些需要被删除.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)

    blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, cascade<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;save-update, delete-orphan&#39;</span>)


<span style="color: #000000; font-weight: bold">if</span> __name__ <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;__main__&#39;</span>:

    session <span style="color: #000000; font-weight: bold">=</span> Session()

    <span style="color: #999988; font-style: italic">#user = User(name=u&#39;用户&#39;)</span>
    <span style="color: #999988; font-style: italic">#blog = Blog(title=u&#39;一&#39;)</span>
    <span style="color: #999988; font-style: italic">#blog2 = Blog(title=u&#39;二&#39;)</span>
    <span style="color: #999988; font-style: italic">#user.blog_list = [blog, blog2]</span>
    <span style="color: #999988; font-style: italic">#session.add(user)</span>
    user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>first()
    blog2 <span style="color: #000000; font-weight: bold">=</span>  session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>title <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">u&#39;二&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>first()
    user<span style="color: #000000; font-weight: bold">.</span>blog_list <span style="color: #000000; font-weight: bold">=</span> [blog2]
    <span style="color: #999988; font-style: italic">#session.delete(user)</span>
    session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">merge</em></dt><dd style="">
    这个选项是标识在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">session.merge()</code> 时处理关联对象. <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">session.merge()</code> 的作用, 是把一个会话外的实例, "整合"进会话, 比如 "有则修改, 无则创建" 就是典型的一种 "整合":
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user <span style="color: #000000; font-weight: bold">=</span> User(<span style="color: #0086B3">id</span><span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">1</span>, name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&quot;1&quot;</span>)
session<span style="color: #000000; font-weight: bold">.</span>add(user)
session<span style="color: #000000; font-weight: bold">.</span>commit()

user <span style="color: #000000; font-weight: bold">=</span> User(<span style="color: #0086B3">id</span><span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">1</span>)
user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>merge(user)
<span style="color: #000000; font-weight: bold">print</span> user<span style="color: #000000; font-weight: bold">.</span>name

user <span style="color: #000000; font-weight: bold">=</span> User(<span style="color: #0086B3">id</span><span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">1</span>, name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&quot;2&quot;</span>)
user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>merge(user)
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">cascade</code> 中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">merge</code> 作用:
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)

    blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>,
                             cascade<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;save-update, delete, delete-orphan, merge&#39;</span>)


<span style="color: #000000; font-weight: bold">if</span> __name__ <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;__main__&#39;</span>:

    session <span style="color: #000000; font-weight: bold">=</span> Session()

    user <span style="color: #000000; font-weight: bold">=</span> User(<span style="color: #0086B3">id</span><span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">1</span>, name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;1&#39;</span>)
    session<span style="color: #000000; font-weight: bold">.</span>add(user)
    session<span style="color: #000000; font-weight: bold">.</span>commit(user)

    user <span style="color: #000000; font-weight: bold">=</span> User(<span style="color: #0086B3">id</span><span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">1</span>, blog_list<span style="color: #000000; font-weight: bold">=</span>[Blog(title<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;哈哈&#39;</span>)])
    session<span style="color: #000000; font-weight: bold">.</span>merge(user)

    session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">refresh-expire</em></dt><dd style="">
    当使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">session.expire()</code> 标识一个对象过期时, 此对象的关联对象是否也被标识为过期(访问属性会重新查询数据库).
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)

    blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>,
            cascade<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;save-update, delete, delete-orphan, merge, refresh-expire&#39;</span>)


<span style="color: #000000; font-weight: bold">if</span> __name__ <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;__main__&#39;</span>:

    session <span style="color: #000000; font-weight: bold">=</span> Session()

    <span style="color: #999988; font-style: italic">#user = User(id=1, name=&#39;1&#39;)</span>
    <span style="color: #999988; font-style: italic">#blog = Blog(title=&quot;abc&quot;)</span>
    <span style="color: #999988; font-style: italic">#user.blog_list = [blog]</span>
    <span style="color: #999988; font-style: italic">#session.add(user)</span>

    user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>first()
    blog <span style="color: #000000; font-weight: bold">=</span> user<span style="color: #000000; font-weight: bold">.</span>blog_list[<span style="color: #009999">0</span>]
    <span style="color: #000000; font-weight: bold">print</span> user<span style="color: #000000; font-weight: bold">.</span>name
    <span style="color: #000000; font-weight: bold">print</span> blog<span style="color: #000000; font-weight: bold">.</span>title
    session<span style="color: #000000; font-weight: bold">.</span>expire(user)
    <span style="color: #000000; font-weight: bold">print</span> <span style="color: #dd1144">&#39;EXPIRE&#39;</span>
    <span style="color: #000000; font-weight: bold">print</span> user<span style="color: #000000; font-weight: bold">.</span>name
    <span style="color: #000000; font-weight: bold">print</span> blog<span style="color: #000000; font-weight: bold">.</span>title

    session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">expunge</em></dt><dd style="">
    与 <em style="color: #d75100; font-style: normal;">merge</em> 相反, 当 <em style="color: #d75100; font-style: normal;">session.expunge()</em> 把对象从会话中去除的时候, 此对象的关联对象也同时从会话中消失.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">64</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(BIGINT, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(String(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>, nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>)

    blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>, cascade<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;delete, delete-orphan, expunge&#39;</span>)


<span style="color: #000000; font-weight: bold">if</span> __name__ <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;__main__&#39;</span>:

    session <span style="color: #000000; font-weight: bold">=</span> Session()
    user <span style="color: #000000; font-weight: bold">=</span> User(name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">u&#39;用户&#39;</span>)
    blog <span style="color: #000000; font-weight: bold">=</span> Blog(title<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">u&#39;第一个&#39;</span>)
    user<span style="color: #000000; font-weight: bold">.</span>blog_list <span style="color: #000000; font-weight: bold">=</span> [blog]

    session<span style="color: #000000; font-weight: bold">.</span>add(user)
    session<span style="color: #000000; font-weight: bold">.</span>add(blog)

    session<span style="color: #000000; font-weight: bold">.</span>expunge(user)
    <span style="color: #000000; font-weight: bold">print</span> blog <span style="color: #000000; font-weight: bold">in</span> session

    <span style="color: #999988; font-style: italic">#session.commit()</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

</dd>
</dl>

<a class="anchor" name="toc22"></a>
<h2 style="font-size: 18px; margin: 30px auto;">4.8. 属性代理</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
考虑这样的情况, 关系是关联的整个模型对象的, 但是, 有时我们对于这个关系, 并不关心整个对象, 只关心其中的某个属性. 考虑下面的场景:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.ext.associationproxy</span> <span style="color: #000000; font-weight: bold">import</span> association_proxy

<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(Integer, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)

    blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>)
    blog_title_list <span style="color: #000000; font-weight: bold">=</span> association_proxy(<span style="color: #dd1144">&#39;blog_list&#39;</span>, <span style="color: #dd1144">&#39;title&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">blog_list</code> 是一个正确的一对多关系. 下面的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">blog_title_list</code> 就是这个关系上的一个属性代理. <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">blog_title_list</code> 只处理 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">blog_list</code> 这个关系中对应的对象的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">title</code> 属性, 包括获取和设置两个方向.
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session <span style="color: #000000; font-weight: bold">=</span> Session()

user <span style="color: #000000; font-weight: bold">=</span> User(name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;xxx&#39;</span>)
user<span style="color: #000000; font-weight: bold">.</span>blog_list <span style="color: #000000; font-weight: bold">=</span> [Blog(title<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;ABC&#39;</span>)]
session<span style="color: #000000; font-weight: bold">.</span>add(user)
session<span style="color: #000000; font-weight: bold">.</span>commit()

user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>first()
<span style="color: #000000; font-weight: bold">print</span> user<span style="color: #000000; font-weight: bold">.</span>blog_title_list
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面是获取属性的示例. 在"设置", 或者说"创建"时, 直接操作是有错的:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>first()
user<span style="color: #000000; font-weight: bold">.</span>blog_title_list <span style="color: #000000; font-weight: bold">=</span> [<span style="color: #dd1144">&#39;NEW&#39;</span>]
session<span style="color: #000000; font-weight: bold">.</span>add(user)
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
原因在于, 对于类 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Blog</code> 的初始化形式. <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">association_proxy('blog_list', 'title')</code> 中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">title</code> 只是获取时的属性定义, 而在上面的设置过程中, 实际上的调用形式为:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">Blog(<span style="color: #dd1144">&#39;NEW&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Blog</code> 类没有明确定义 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">__init__()</code> 方法, 所有这种形式的调用会报错. 可以把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">__init__()</code> 方法补上:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(Integer, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)

    <span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">__init__</span>(<span style="color: #999999">self</span>, title):
        <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>title <span style="color: #000000; font-weight: bold">=</span> title
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这样调用就没有问题了.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
另一个方法, 是在调用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">association_proxy()</code> 时使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">creator</code> 参数明确定义"值"和"实例"的关系:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)

    blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>)
    blog_title_list <span style="color: #000000; font-weight: bold">=</span> association_proxy(<span style="color: #dd1144">&#39;blog_list&#39;</span>, <span style="color: #dd1144">&#39;title&#39;</span>,
                                        creator<span style="color: #000000; font-weight: bold">=lambda</span> t: User(title<span style="color: #000000; font-weight: bold">=</span>t))
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">creator</code> 定义的方法, 返回的对象可以被对应的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">blog_list</code> 关系接收即可.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在查询方面, <em style="color: #d75100; font-style: normal;">多对一</em> 的关系代理上, 可以直接使用属性:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;blog&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    title <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(Integer, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)

    user_obj <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;User&#39;</span>)
    user_name <span style="color: #000000; font-weight: bold">=</span> association_proxy(<span style="color: #dd1144">&#39;user_obj&#39;</span>, <span style="color: #dd1144">&#39;name&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
查询:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">blog <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Blog)<span style="color: #000000; font-weight: bold">.</span>filter(Blog<span style="color: #000000; font-weight: bold">.</span>user_name <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">u&#39;XX&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>first()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
反过来的 <em style="color: #d75100; font-style: normal;">一对多</em> 关系代理上, 可以使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">contains()</code> 函数:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter(User<span style="color: #000000; font-weight: bold">.</span>blogs_title<span style="color: #000000; font-weight: bold">.</span>contains(<span style="color: #dd1144">&#39;A&#39;</span>))<span style="color: #000000; font-weight: bold">.</span>first()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc23"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">5. 会话与事务控制</h1>

<a class="anchor" name="toc24"></a>
<h2 style="font-size: 18px; margin: 30px auto;">5.1. 基本使用</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
SQLAlchemy 的 <em style="color: #d75100; font-style: normal;">session</em> 是用于管理数据库操作的一个像容器一样的东西. 模型实例对象本身独立存在, 而要让其修改(创建)生效, 则需要把它们加入某个 session . 同时你也可以把模型实例对象从 session 中去除. 被 session 管理的实例对象, 在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">session.commit()</code> 时被提交到数据库. 同时 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">session.rollback()</code> 是回滚变更.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">session.flush()</code> 的作用是在事务管理内与数据库发生交互, 对应的实例状态被反映到数据库. 比如自增 ID 被填充上值.
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user <span style="color: #000000; font-weight: bold">=</span> User(name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">u&#39;名字&#39;</span>)
session<span style="color: #000000; font-weight: bold">.</span>add(user)
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">try</span>:
    user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>Query(User)<span style="color: #000000; font-weight: bold">.</span>first()
    user<span style="color: #000000; font-weight: bold">.</span>name <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">u&#39;改名字</span>
    session<span style="color: #000000; font-weight: bold">.</span>commit()
<span style="color: #000000; font-weight: bold">except</span>:
    session<span style="color: #000000; font-weight: bold">.</span>rollback()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc25"></a>
<h2 style="font-size: 18px; margin: 30px auto;">5.2. for update</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
SQLAlchemy 的 <em style="color: #d75100; font-style: normal;">Query</em> 支持 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">select ... for update / share</code> .
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session<span style="color: #000000; font-weight: bold">.</span>Query(User)<span style="color: #000000; font-weight: bold">.</span>with_for_update()<span style="color: #000000; font-weight: bold">.</span>first()
session<span style="color: #000000; font-weight: bold">.</span>Query(User)<span style="color: #000000; font-weight: bold">.</span>with_for_update(read<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)<span style="color: #000000; font-weight: bold">.</span>first()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
完整形式是:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">with_for_update(read<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>, nowait<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>, of<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">None</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<dl style="">
<dt style=""><em style="color: #d75100; font-style: normal;">read</em></dt><dd style="">
    是标识加互斥锁还是共享锁. 当为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">True</code> 时, 即 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">for share</code> 的语句, 是共享锁. 多个事务可以获取共享锁, 互斥锁只能一个事务获取. 有"多个地方"都希望是"这段时间我获取的数据不能被修改, 我也不会改", 那么只能使用共享锁.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">nowait</em></dt><dd style="">
    其它事务碰到锁, 是否不等待直接"报错".
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">of</em></dt><dd style="">
    指明上锁的表, 如果不指明, 则查询中涉及的所有表(行)都会加锁.
</dd>
</dl>

<a class="anchor" name="toc26"></a>
<h2 style="font-size: 18px; margin: 30px auto;">5.3. 事务嵌套</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
SQLAlchemy 中的事务嵌套有两种情况. 一是在 session 中管理的事务, 本身有层次性. 二是 session 和原始的 connection 之间, 是一种层次关系, 在这 session , connection 两个概念之中的事务同样具有这样的层次.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
session 中的事务, 可能通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">begin_nested()</code> 方法做 <em style="color: #d75100; font-style: normal;">savepoint</em> :
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session<span style="color: #000000; font-weight: bold">.</span>add(u1)
session<span style="color: #000000; font-weight: bold">.</span>add(u2)

session<span style="color: #000000; font-weight: bold">.</span>begin_nested()
session<span style="color: #000000; font-weight: bold">.</span>add(u3)
session<span style="color: #000000; font-weight: bold">.</span>rollback() <span style="color: #999988; font-style: italic"># rolls back u3, keeps u1 and u2</span>

session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
或者使用上下文对象:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">for</span> record <span style="color: #000000; font-weight: bold">in</span> records:
    <span style="color: #000000; font-weight: bold">try</span>:
        <span style="color: #000000; font-weight: bold">with</span> session<span style="color: #000000; font-weight: bold">.</span>begin_nested():
            session<span style="color: #000000; font-weight: bold">.</span>merge(record)
    <span style="color: #000000; font-weight: bold">except</span>:
        <span style="color: #000000; font-weight: bold">print</span> <span style="color: #dd1144">&quot;Skipped record %s&quot;</span> <span style="color: #000000; font-weight: bold">%</span> record
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
嵌套的事务的一个效果, 是最外层事务提交整个变更才会生效.
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user <span style="color: #000000; font-weight: bold">=</span> User(name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;2&#39;</span>)

session<span style="color: #000000; font-weight: bold">.</span>begin_nested()
session<span style="color: #000000; font-weight: bold">.</span>add(user)
session<span style="color: #000000; font-weight: bold">.</span>commit()

session<span style="color: #000000; font-weight: bold">.</span>rollback()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
于是, 前面说的第二种情况有一种应用方式, 就是在 connection 上做一个事务, 最终也在 connection 上回滚这个事务, 如果 session 是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">bind</code> 到这个连接上的, 那么 session 上所做的更改全部不会生效:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">conn <span style="color: #000000; font-weight: bold">=</span> Engine<span style="color: #000000; font-weight: bold">.</span>connect()
session <span style="color: #000000; font-weight: bold">=</span> Session(bind<span style="color: #000000; font-weight: bold">=</span>conn)
trans <span style="color: #000000; font-weight: bold">=</span> conn<span style="color: #000000; font-weight: bold">.</span>begin()

user <span style="color: #000000; font-weight: bold">=</span> User(name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;2&#39;</span>)
session<span style="color: #000000; font-weight: bold">.</span>begin_nested()
session<span style="color: #000000; font-weight: bold">.</span>add(user)
session<span style="color: #000000; font-weight: bold">.</span>commit()

session<span style="color: #000000; font-weight: bold">.</span>commit()

trans<span style="color: #000000; font-weight: bold">.</span>rollback()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在测试中这种方式可能会有用.
</p>

<a class="anchor" name="toc27"></a>
<h2 style="font-size: 18px; margin: 30px auto;">5.4. 二段式提交</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
二段式提交, Two-Phase, 是为解决分布式环境下多点事务控制的一套协议.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
与一般事务控制的不同是, 一般事务是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">begin</code>, 之后 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">commit</code> 结束.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
而二段式提交的流程上, <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">begin</code> 之后, 是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">prepare transaction 'transaction_id'</code> , 这时相关事务数据已经持久化了. 之后, 再在任何时候(哪怕重启服务), 作 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">commit prepared 'transaction_id'</code> 或者 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">rollback prepared 'transaction_id'</code> .
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
从多点事务的控制来看, 应用层要做的事是, 先把任务分发出去, 然后收集"事务准备"的状态( <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">prepare transaction</code> 的结果). 根据收集的结果决定最后是 commit 还是 rollback .
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
简单来说, 就是事务先保存, 再说提交的事.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
SQLAlchemy 中对这个机制的支持, 是在构建会话类是加入 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">twophase</code> 参数:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">Session <span style="color: #000000; font-weight: bold">=</span> sessionmaker(twophase<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
然后会话类可以根据一些策略, 绑定多个 <em style="color: #d75100; font-style: normal;">Engine</em> , 可以是多个数据库连接, 比如:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">Session <span style="color: #000000; font-weight: bold">=</span> sessionmaker(twophase<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
Session<span style="color: #000000; font-weight: bold">.</span>configure(binds<span style="color: #000000; font-weight: bold">=</span>{User: Engine, Blog: Engine2})
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这样, 在获取一个会话实例之后, 就处在二段式提交机制的支持之下, SQLAlchemy 自己会作多点的协调了. 完整的流程:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">Engine <span style="color: #000000; font-weight: bold">=</span> create_engine(<span style="color: #dd1144">&#39;postgresql://test@localhost:5432/test&#39;</span>, echo<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
Engine2 <span style="color: #000000; font-weight: bold">=</span> create_engine(<span style="color: #dd1144">&#39;postgresql://test@localhost:5432/test2&#39;</span>, echo<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)

Session <span style="color: #000000; font-weight: bold">=</span> sessionmaker(twophase<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)

Session<span style="color: #000000; font-weight: bold">.</span>configure(binds<span style="color: #000000; font-weight: bold">=</span>{User: Engine, Blog: Engine2})
session <span style="color: #000000; font-weight: bold">=</span> Session()

user <span style="color: #000000; font-weight: bold">=</span> User(name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">u&#39;名字&#39;</span>)
session<span style="color: #000000; font-weight: bold">.</span>add(user)
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对应的 SQL 大概就是:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">begin</span>;
<span style="color: #000000; font-weight: bold">insert</span> <span style="color: #000000; font-weight: bold">into</span> <span style="color: #990073">&quot;user&quot;</span> (name) <span style="color: #000000; font-weight: bold">values</span> (<span style="color: #000000; font-weight: bold">?</span>);
<span style="color: #000000; font-weight: bold">prepare</span> transaction <span style="color: #dd1144">&#39;xx&#39;</span>;
<span style="color: #000000; font-weight: bold">commit</span> prepared <span style="color: #dd1144">&#39;xx&#39;</span>;
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
使用时, Postgresql 数据库需要把 <em style="color: #d75100; font-style: normal;">max_prepared_transactions</em> 这个配置项的值改成大于 0 .
</p>

<a class="anchor" name="toc28"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">6. 字段类型</h1>

<a class="anchor" name="toc29"></a>
<h2 style="font-size: 18px; margin: 30px auto;">6.1. 基本类型</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
字段类型是在定义模型时, 对每个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Column</code> 的类型约定. 不同类型的字段类型在输入输出上, 及支持的操作方面, 有所区别.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里只介绍 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">sqlalchemy.types.*</code> 中的类型, SQL 标准类型方面, 是写什么最后生成的 DDL 语句就是什么, 比如 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">BIGINT</code>, <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">BLOG</code> 这些, 但是这些类型并不一定在所有数据库中都有支持. 除此而外, SQLAlchemy 也支持一些特定数据库的特定类型, 这些需要从具体的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">dialects</code> 实现里导入.
</p>

<dl style="">
<dt style=""><em style="color: #d75100; font-style: normal;">Integer/BigInteger/SmallInteger</em></dt><dd style="">
    整形.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">Boolean</em></dt><dd style="">
    布尔类型. Python 中表现为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">True/False</code> , 数据库根据支持情况, 表现为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">BOOLEAN</code> 或 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">SMALLINT</code> . 实例化时可以指定是否创建约束(默认创建).
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">Date/DateTime/Time</em> <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">(timezone=False)</code></dt><dd style="">
    日期类型, <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Time</code> 和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">DateTime</code> 实例化时可以指定是否带时区信息.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">Interval</em></dt><dd style="">
    时间偏差类型. 在 Python 中表现为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">datetime.timedelta()</code> , 数据库不支持此类型则存为日期.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">Enum</em> <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">(*enums, **kw)</code></dt><dd style="">
    枚举类型, 根据数据库支持情况, SQLAlchemy 会使用原生支持或者使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">VARCHAR</code> 类型附加约束的方式实现. 原生支持中涉及新类型创建, 细节在实例化时控制.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">Float</em></dt><dd style="">
    浮点小数.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">Numeric</em> <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">(precision=None, scale=None, decimal_return_scale=None, ...)</code></dt><dd style="">
    定点小数, Python 中表现为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Decimal</code> .
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">LargeBinary</em> <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">(length=None)</code></dt><dd style="">
    字节数据. 根据数据库实现, 在实例化时可能需要指定大小.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">PickleType</em></dt><dd style="">
    Python 对象的序列化类型.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">String</em> <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">(length=None, collation=None, ...)</code></dt><dd style="">
    字符串类型, Python 中表现为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Unicode</code> , 数据库表现为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">VARCHAR</code> , 通常都需要指定长度.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">Unicode</em></dt><dd style="">
    类似与字符串类型, 在某些数据库实现下, 会明确表示支持非 ASCII 字符. 同时输入输出也强制是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Unicode</code> 类型.
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">Text</em></dt><dd style="">
    长文本类型, Python 表现为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Unicode</code> , 数据库表现为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">TEXT</code> .
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">UnicodeText</em></dt><dd style="">
    参考 <em style="color: #d75100; font-style: normal;">Unicode</em> .
</dd>
</dl>

<a class="anchor" name="toc30"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">7. 混合属性机制</h1>

<a class="anchor" name="toc31"></a>
<h2 style="font-size: 18px; margin: 30px auto;">7.1. 直接行为</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
混合属性, 官方文档中称之为 <em style="color: #d75100; font-style: normal;">Hybrid Attributes</em> . 这种机制表现为, 一个属性, 在 <em style="color: #d75100; font-style: normal;">类</em> 和层面, 和 <em style="color: #d75100; font-style: normal;">实例</em> 的层面, 其行为是不同的. 之所以需要关注这部分的差异, 原因源于 Python 上下文和 SQL 上下文的差异.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">类</em> 层面经常是作为 SQL 查询时的一部分, 它面向的是 SQL 上下文. 而 <em style="color: #d75100; font-style: normal;">实例</em> 是已经得到或者创建的结果, 它面向的是 Python 上下文.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
定义模型的 <em style="color: #d75100; font-style: normal;">Column()</em> 就是一个典型的混合属性. 作为实例属性时, 是具体的对象值访问, 而作为类属性时, 则有构成 SQL 语句表达式的功能.
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Interval</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;interval&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    start <span style="color: #000000; font-weight: bold">=</span> Column(Integer)
    end <span style="color: #000000; font-weight: bold">=</span> Column(Integer)

session<span style="color: #000000; font-weight: bold">.</span>add(Interval(start<span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">0</span>, end<span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">100</span>))
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
实例行为:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">ins <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Interval)<span style="color: #000000; font-weight: bold">.</span>first()
<span style="color: #000000; font-weight: bold">print</span> ins<span style="color: #000000; font-weight: bold">.</span>end <span style="color: #000000; font-weight: bold">-</span> ins<span style="color: #000000; font-weight: bold">.</span>start
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
类行为:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">ins <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Interval)<span style="color: #000000; font-weight: bold">.</span>filter(Interval<span style="color: #000000; font-weight: bold">.</span>end <span style="color: #000000; font-weight: bold">-</span> Interval<span style="color: #000000; font-weight: bold">.</span>start <span style="color: #000000; font-weight: bold">&gt;</span> <span style="color: #009999">10</span>)<span style="color: #000000; font-weight: bold">.</span>first()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这种机制其实一直在被使用, 但是可能大家都没有留意一个属性在类和实例上的区别.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如果属性需要被进一步封装, 那么就需要明确声明 <em style="color: #d75100; font-style: normal;">Hybrid Attributes</em> 了:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.ext.hybrid</span> <span style="color: #000000; font-weight: bold">import</span> hybrid_property, hybrid_method

<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Interval</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;interval&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    start <span style="color: #000000; font-weight: bold">=</span> Column(Integer)
    end <span style="color: #000000; font-weight: bold">=</span> Column(Integer)

    <span style="color: #3c5d5d; font-weight: bold">@hybrid_property</span>
    <span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">length</span>(<span style="color: #999999">self</span>):
        <span style="color: #000000; font-weight: bold">return</span> <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>end <span style="color: #000000; font-weight: bold">-</span> <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>start

    <span style="color: #3c5d5d; font-weight: bold">@hybrid_method</span>
    <span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">bigger</span>(<span style="color: #999999">self</span>, i):
        <span style="color: #000000; font-weight: bold">return</span> <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>length <span style="color: #000000; font-weight: bold">&gt;</span> i


session<span style="color: #000000; font-weight: bold">.</span>add(Interval(start<span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">0</span>, end<span style="color: #000000; font-weight: bold">=</span><span style="color: #009999">100</span>))
session<span style="color: #000000; font-weight: bold">.</span>commit()

ins <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Interval)<span style="color: #000000; font-weight: bold">.</span>filter(Interval<span style="color: #000000; font-weight: bold">.</span>length <span style="color: #000000; font-weight: bold">&gt;</span> <span style="color: #009999">10</span>)<span style="color: #000000; font-weight: bold">.</span>first()
ins <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Interval)<span style="color: #000000; font-weight: bold">.</span>filter(Interval<span style="color: #000000; font-weight: bold">.</span>bigger(<span style="color: #009999">10</span>))<span style="color: #000000; font-weight: bold">.</span>first()
<span style="color: #000000; font-weight: bold">print</span> ins<span style="color: #000000; font-weight: bold">.</span>bigger(<span style="color: #009999">1</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">setter</em> 的定义同样使用对应的装饰器即可:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Interval</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;interval&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    start <span style="color: #000000; font-weight: bold">=</span> Column(Integer)
    end <span style="color: #000000; font-weight: bold">=</span> Column(Integer)

    <span style="color: #3c5d5d; font-weight: bold">@hybrid_property</span>
    <span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">length</span>(<span style="color: #999999">self</span>):
        <span style="color: #000000; font-weight: bold">return</span> <span style="color: #0086B3">abs</span>(<span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>end <span style="color: #000000; font-weight: bold">-</span> <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>start)

    <span style="color: #3c5d5d; font-weight: bold">@length.setter</span>
    <span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">length</span>(<span style="color: #999999">self</span>, l):
        <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>end <span style="color: #000000; font-weight: bold">=</span> <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>start <span style="color: #000000; font-weight: bold">+</span> l
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc32"></a>
<h2 style="font-size: 18px; margin: 30px auto;">7.2. 表达式行为</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
前面说的属性, 在类和实例上有不同行为, 可以看到, 在类上的行为, 其实就是生成 SQL 表达式时的行为. 上面的例子只是简单的运算, SQLAlchemy 可以自动处理好 Python 函数和 SQL 函数的区别. 但是如果是一些特性更强的 SQL 函数, 就需要手动指定了. 于时, 这时的情况变成, 实例行为是 Python 范畴的调用行为, 而类行为则是生成 SQL 函数的相关表达式.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
同时是前面的例子, 对于 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">length</code> 的定义, 更严格上来说, 应该是取绝对值的.
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Interval</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;interval&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    start <span style="color: #000000; font-weight: bold">=</span> Column(Integer)
    end <span style="color: #000000; font-weight: bold">=</span> Column(Integer)

    <span style="color: #3c5d5d; font-weight: bold">@hybrid_property</span>
    <span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">length</span>(<span style="color: #999999">self</span>):
        <span style="color: #000000; font-weight: bold">return</span> <span style="color: #0086B3">abs</span>(<span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>end <span style="color: #000000; font-weight: bold">-</span> <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>start)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
但是, 如果使用了 Python 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">abs()</code> 函数, 在生成 SQL 表达式时显示有无法处理了. 所以, 需要手动定义:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> func

<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Interval</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;interval&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    start <span style="color: #000000; font-weight: bold">=</span> Column(Integer)
    end <span style="color: #000000; font-weight: bold">=</span> Column(Integer)

    <span style="color: #3c5d5d; font-weight: bold">@hybrid_property</span>
    <span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">length</span>(<span style="color: #999999">self</span>):
        <span style="color: #000000; font-weight: bold">return</span> <span style="color: #0086B3">abs</span>(<span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>end <span style="color: #000000; font-weight: bold">-</span> <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>start)

    <span style="color: #3c5d5d; font-weight: bold">@length.expression</span>
    <span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">length</span>(<span style="color: #999999">self</span>):
        <span style="color: #000000; font-weight: bold">return</span> func<span style="color: #000000; font-weight: bold">.</span>abs(<span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>end <span style="color: #000000; font-weight: bold">-</span> <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>start)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这样查询时就可以直接使用:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">ins <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Interval)<span style="color: #000000; font-weight: bold">.</span>filter(Interval<span style="color: #000000; font-weight: bold">.</span>length <span style="color: #000000; font-weight: bold">&gt;</span> <span style="color: #009999">1</span>)<span style="color: #000000; font-weight: bold">.</span>first()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对应的 SQL :
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">SELECT</span> <span style="color: #000000; font-weight: bold">*</span>
<span style="color: #000000; font-weight: bold">FROM</span> <span style="color: #0086B3">interval</span>
<span style="color: #000000; font-weight: bold">WHERE</span> <span style="color: #000000; font-weight: bold">abs</span>(<span style="color: #0086B3">interval</span>.<span style="color: #990073">&quot;end&quot;</span> <span style="color: #000000; font-weight: bold">-</span> <span style="color: #0086B3">interval</span>.<span style="color: #000000; font-weight: bold">start</span>) <span style="color: #000000; font-weight: bold">&gt;</span> <span style="color: #000000; font-weight: bold">?</span>
 <span style="color: #000000; font-weight: bold">LIMIT</span> <span style="color: #000000; font-weight: bold">?</span> <span style="color: #000000; font-weight: bold">OFFSET</span> <span style="color: #000000; font-weight: bold">?</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc33"></a>
<h2 style="font-size: 18px; margin: 30px auto;">7.3. 应用于关系</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
总体上没有特别之处:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Account</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;account&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    user <span style="color: #000000; font-weight: bold">=</span> Column(Integer, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    balance <span style="color: #000000; font-weight: bold">=</span> Column(Integer, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;0&#39;</span>)


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;user&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)

    accounts <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Account&#39;</span>)
    <span style="color: #999988; font-style: italic">#balance = association_proxy(&#39;accounts&#39;, &#39;balance&#39;)</span>

    <span style="color: #3c5d5d; font-weight: bold">@hybrid_property</span>
    <span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">balance</span>(<span style="color: #999999">self</span>):
        <span style="color: #000000; font-weight: bold">return</span> <span style="color: #0086B3">sum</span>(x<span style="color: #000000; font-weight: bold">.</span>balance <span style="color: #000000; font-weight: bold">for</span> x <span style="color: #000000; font-weight: bold">in</span> <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>accounts)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
查询时:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>first()
<span style="color: #000000; font-weight: bold">print</span> user<span style="color: #000000; font-weight: bold">.</span>balance
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里涉及的东西都是 Python 自己的, 包括那个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">sum()</code> 函数, 和 SQL 没有关系.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如果想实现的是, 使用 SQL 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">sum()</code> 函数, 取出指定用户的总账户金额数, 那么就要考虑把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">balance</code> 作成表达式的形式:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> select

<span style="color: #3c5d5d; font-weight: bold">@hybrid_property</span>
<span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">balance</span>(<span style="color: #999999">self</span>):
    <span style="color: #000000; font-weight: bold">return</span> select([func<span style="color: #000000; font-weight: bold">.</span>sum(Account<span style="color: #000000; font-weight: bold">.</span>balance)])<span style="color: #000000; font-weight: bold">.</span>where(Account<span style="color: #000000; font-weight: bold">.</span>user <span style="color: #000000; font-weight: bold">==</span> <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>label(<span style="color: #dd1144">&#39;balance_v&#39;</span>)
    <span style="color: #999988; font-style: italic">#return func.sum(Account.balance)</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这样的话, <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">User.balance</code> 只是单纯的一个表达式了, 查询时指定字段:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User, User<span style="color: #000000; font-weight: bold">.</span>balance)<span style="color: #000000; font-weight: bold">.</span>first()
<span style="color: #000000; font-weight: bold">print</span> user<span style="color: #000000; font-weight: bold">.</span>balance_v
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
注意, 如果写成:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">session<span style="color: #000000; font-weight: bold">.</span>query(User<span style="color: #000000; font-weight: bold">.</span>balance)<span style="color: #000000; font-weight: bold">.</span>first()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
意义就不再是"获取第一个用户的总金额", 而变成"获取总金额的第一个". 这里很坑吧.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
像上面这样改, 实例层面就无法使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">balance</code> 属性. 所以, 还是先前介绍的, 表达式可以单独处理:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #3c5d5d; font-weight: bold">@hybrid_property</span>
<span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">balance</span>(<span style="color: #999999">self</span>):
    <span style="color: #000000; font-weight: bold">return</span> <span style="color: #0086B3">sum</span>(x<span style="color: #000000; font-weight: bold">.</span>balance <span style="color: #000000; font-weight: bold">for</span> x <span style="color: #000000; font-weight: bold">in</span> <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>accounts)

<span style="color: #3c5d5d; font-weight: bold">@balance.expression</span>
<span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">balance</span>(<span style="color: #999999">self</span>):
    <span style="color: #000000; font-weight: bold">return</span> select([func<span style="color: #000000; font-weight: bold">.</span>sum(Account<span style="color: #000000; font-weight: bold">.</span>balance)])<span style="color: #000000; font-weight: bold">.</span>where(Account<span style="color: #000000; font-weight: bold">.</span>user <span style="color: #000000; font-weight: bold">==</span> <span style="color: #999999">self</span><span style="color: #000000; font-weight: bold">.</span>id)<span style="color: #000000; font-weight: bold">.</span>label(<span style="color: #dd1144">&#39;balance_v&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
定义了表达式的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">balance</code> , 这部分作为查询条件上当然也是可以的:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">user <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(User)<span style="color: #000000; font-weight: bold">.</span>filter(User<span style="color: #000000; font-weight: bold">.</span>balance <span style="color: #000000; font-weight: bold">&gt;</span> <span style="color: #009999">1</span>)<span style="color: #000000; font-weight: bold">.</span>first()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc34"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">8. 示例: AdjacencyList, 单向链接列表</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里说的 <em style="color: #d75100; font-style: normal;">AdjacencyList</em> , 就是最常用来在关系数据库中表示树结构的, <em style="color: #d75100; font-style: normal;">parent</em> 方式:
</p>

<table border="1" style="border: 1px solid gray; border-collapse: collapse; margin: 25px auto; line-height: 1.4em; font-size: 14px;">
<tr>
<th style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">id</th>
<th style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">name</th>
<th colspan="2" style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">parent</th>
</tr>
<tr>
<td style="border: 1px solid gray; padding: 3px 10px;">1</td>
<td style="border: 1px solid gray; padding: 3px 10px;">一</td>
<td style="border: 1px solid gray; padding: 3px 10px;">null</td>
</tr>
<tr>
<td style="border: 1px solid gray; padding: 3px 10px;">2</td>
<td style="border: 1px solid gray; padding: 3px 10px;">二</td>
<td style="border: 1px solid gray; padding: 3px 10px;">1</td>
</tr>
<tr>
<td style="border: 1px solid gray; padding: 3px 10px;">3</td>
<td style="border: 1px solid gray; padding: 3px 10px;">三</td>
<td style="border: 1px solid gray; padding: 3px 10px;">2</td>
</tr>
</table>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面的数据, 表示的结构就是:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">一
  |- 二
    |- 三
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
模型定义很好做:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #999988; font-style: italic"># -*- coding: utf-8 -*-</span>

<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> create_engine
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.ext.declarative</span> <span style="color: #000000; font-weight: bold">import</span> declarative_base
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy</span> <span style="color: #000000; font-weight: bold">import</span> Column, ForeignKey
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.types</span> <span style="color: #000000; font-weight: bold">import</span> Integer, Unicode
<span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.orm</span> <span style="color: #000000; font-weight: bold">import</span> relationship, sessionmaker, joinedload

BaseModel <span style="color: #000000; font-weight: bold">=</span> declarative_base()
Engine <span style="color: #000000; font-weight: bold">=</span> create_engine(<span style="color: #dd1144">&#39;sqlite://&#39;</span>, echo<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
Session <span style="color: #000000; font-weight: bold">=</span> sessionmaker(Engine)

<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Node</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;node&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)
    parent <span style="color: #000000; font-weight: bold">=</span> Column(Integer, ForeignKey(<span style="color: #dd1144">&#39;node.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>,
                    nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;0&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里不让 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">parent</code> 字段有 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">null</code> , 而使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">0</code> 代替.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这个例子在关系上, 有一个纠结的地方, 因为 <em style="color: #d75100; font-style: normal;">node</em> 这个表, 它是自关联的, 所以如果想要 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">children</code> 和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">parent_obj</code> 这两个关系时:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">children <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Node&#39;</span>)
parent_obj <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Node&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
呃, 尴尬了.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如果是两个表, 那么 SQLAlchemy 可以通过外键在哪张表这个信息, 来确定关系的方向:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Blog</span>(BaseModel):
    <span style="color: #000000; font-weight: bold">...</span>
    user <span style="color: #000000; font-weight: bold">=</span> Column(Integer, ForeignKey(<span style="color: #dd1144">&#39;user.id&#39;</span>))
    user_obj <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;User&#39;</span>)

<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">User</span>(BaseModel):
    <span style="color: #000000; font-weight: bold">...</span>
    blog_list <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Blog&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
因为外键在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Blog</code> 中, 所以 <em style="color: #d75100; font-style: normal;">Blog -&gt; User</em> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">user_obj</code> 是一个 <em style="color: #d75100; font-style: normal;">N -&gt; 1</em> 关系.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
反之, <em style="color: #d75100; font-style: normal;">User -&gt; Blog</em> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">blog_list</code> 则是一个 <em style="color: #d75100; font-style: normal;">1 -&gt; N</em> 的关系.
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
而自相关的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Node</code> 无法直接判断方向, 所以 SQLAlchemy 会按 <em style="color: #d75100; font-style: normal;">1 -&gt; N</em> 处理, 那么:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">children <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Node&#39;</span>)
parent_obj <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Node&#39;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这两条之中, <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">children</code> 是正确的, 是我们想要的. 要定义 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">parent_obj</code> 则需要在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">relationship</code> 中通过参数明确表示方向:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">parent_obj <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Node&#39;</span>, remote_side<span style="color: #000000; font-weight: bold">=</span>[<span style="color: #0086B3">id</span>])
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这种方式就定义了一个, "到 id" 的 <em style="color: #d75100; font-style: normal;">N -&gt; 1</em> 关系. 
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
现在完整的模型定义是:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Node</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;node&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)
    parent <span style="color: #000000; font-weight: bold">=</span> Column(Integer, ForeignKey(<span style="color: #dd1144">&#39;node.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>,
                    nullable<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">False</span>, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;0&#39;</span>)

    children <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Node&#39;</span>) <span style="color: #999988; font-style: italic"># 1 -&gt; N</span>
    parent_obj <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Node&#39;</span>, remote_side<span style="color: #000000; font-weight: bold">=</span>[<span style="color: #0086B3">id</span>])
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
查询方面没什么特殊的了, 不过我发现在自相关的模型关系, <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">lazy</code> 选项不起作用:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">children <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Node&#39;</span>, lazy<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&quot;joined&quot;</span>)
parent_obj <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Node&#39;</span>, remote_side<span style="color: #000000; font-weight: bold">=</span>[<span style="color: #0086B3">id</span>], lazy<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&quot;joined&quot;</span>)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
都是无效的, 只有在查询时, 手动使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">options()</code> 定义:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">n <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Node)<span style="color: #000000; font-weight: bold">.</span>filter(Node<span style="color: #000000; font-weight: bold">.</span>name<span style="color: #000000; font-weight: bold">==</span><span style="color: #dd1144">u&#39;一&#39;</span>)<span style="color: #a61717; background-color: #e3d2d2">\</span>
           <span style="color: #000000; font-weight: bold">.</span>options(joinedload(<span style="color: #dd1144">&#39;parent_obj&#39;</span>))<span style="color: #000000; font-weight: bold">.</span>first()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如果要一次查出多级的子节点:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">n <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Node)<span style="color: #000000; font-weight: bold">.</span>filter(Node<span style="color: #000000; font-weight: bold">.</span>name<span style="color: #000000; font-weight: bold">==</span><span style="color: #dd1144">u&#39;一&#39;</span>)<span style="color: #a61717; background-color: #e3d2d2">\</span>
           <span style="color: #000000; font-weight: bold">.</span>options(joinedload(<span style="color: #dd1144">&#39;children&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>joinedload(<span style="color: #dd1144">&#39;children&#39;</span>))<span style="color: #000000; font-weight: bold">.</span>first()
<span style="color: #000000; font-weight: bold">print</span> n<span style="color: #000000; font-weight: bold">.</span>name, n<span style="color: #000000; font-weight: bold">.</span>children, n<span style="color: #000000; font-weight: bold">.</span>children[<span style="color: #009999">0</span>]<span style="color: #000000; font-weight: bold">.</span>children
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
多个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">joinedload()</code> 串连的话, 可以使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">joinedload_all()</code> 来整合:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">from</span> <span style="color: #555555">sqlalchemy.orm</span> <span style="color: #000000; font-weight: bold">import</span> joinedload_all

n <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Node)<span style="color: #000000; font-weight: bold">.</span>filter(Node<span style="color: #000000; font-weight: bold">.</span>name<span style="color: #000000; font-weight: bold">==</span><span style="color: #dd1144">u&#39;一&#39;</span>)<span style="color: #a61717; background-color: #e3d2d2">\</span>
           <span style="color: #000000; font-weight: bold">.</span>options(joinedload_all(<span style="color: #dd1144">&#39;children&#39;</span>, <span style="color: #dd1144">&#39;children&#39;</span>))<span style="color: #000000; font-weight: bold">.</span>first()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在修改方面, 删除的话, 配置了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">cascade</code> , 删除父节点, 则子节点也会自动删除:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">children <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Node&#39;</span>, lazy<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;joined&#39;</span>, cascade<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;all&#39;</span>) <span style="color: #999988; font-style: italic"># 1 -&gt; N</span>
node <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Node)<span style="color: #000000; font-weight: bold">.</span>filter(Node<span style="color: #000000; font-weight: bold">.</span>name <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">u&#39;一&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>first()
session<span style="color: #000000; font-weight: bold">.</span>delete(node)
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如果只删除子节点, 那么 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">delete-orphan</code> 选项就很好用了:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">children <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Node&#39;</span>, lazy<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;joined&#39;</span>, cascade<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;all, delete-orphan&#39;</span>) <span style="color: #999988; font-style: italic"># 1 -&gt; N</span>
node <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Node)<span style="color: #000000; font-weight: bold">.</span>filter(Node<span style="color: #000000; font-weight: bold">.</span>name <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">u&#39;一&#39;</span>)<span style="color: #000000; font-weight: bold">.</span>first()
node<span style="color: #000000; font-weight: bold">.</span>children <span style="color: #000000; font-weight: bold">=</span> []
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc35"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">9. 示例: 属性实体化建模</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
假设有这样的场景, 某实体在具体条目上, 其属性是不定的, 或者其属性是充分稀疏的:
</p>

<table border="1" style="border: 1px solid gray; border-collapse: collapse; margin: 25px auto; line-height: 1.4em; font-size: 14px;">
<tr>
<th style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">id</th>
<th style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">name</th>
<th style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">attr_0</th>
<th style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">attr_1</th>
<th style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">attr_2</th>
<th style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">...</th>
<th colspan="2" style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">attr_n</th>
</tr>
<tr>
<td style="border: 1px solid gray; padding: 3px 10px;">1</td>
<td style="border: 1px solid gray; padding: 3px 10px;">foo</td>
<td style="border: 1px solid gray; padding: 3px 10px;">1</td>
<td style="border: 1px solid gray; padding: 3px 10px;">abc</td>
<td style="border: 1px solid gray; padding: 3px 10px;">33</td>
<td style="border: 1px solid gray; padding: 3px 10px;">...</td>
<td style="border: 1px solid gray; padding: 3px 10px;">any</td>
</tr>
</table>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这种情况下, 把属性看成是单独的实体, 是一个更好的建模方式:
</p>

<table border="1" style="border: 1px solid gray; border-collapse: collapse; margin: 25px auto; line-height: 1.4em; font-size: 14px;">
<tr>
<th style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">id</th>
<th colspan="2" style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">name</th>
</tr>
<tr>
<td style="border: 1px solid gray; padding: 3px 10px;">1</td>
<td style="border: 1px solid gray; padding: 3px 10px;">foo</td>
</tr>
</table>

<table border="1" style="border: 1px solid gray; border-collapse: collapse; margin: 25px auto; line-height: 1.4em; font-size: 14px;">
<tr>
<th style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">id</th>
<th style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">entity_id</th>
<th style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">attr_name</th>
<th colspan="2" style="border: 1px solid gray; font-weight: bold; text-align: center; padding: 3px 10px;">attr_value</th>
</tr>
<tr>
<td style="border: 1px solid gray; padding: 3px 10px;">1</td>
<td style="border: 1px solid gray; padding: 3px 10px;">1</td>
<td style="border: 1px solid gray; padding: 3px 10px;">attr_0</td>
<td style="border: 1px solid gray; padding: 3px 10px;">1</td>
</tr>
<tr>
<td style="border: 1px solid gray; padding: 3px 10px;">2</td>
<td style="border: 1px solid gray; padding: 3px 10px;">1</td>
<td style="border: 1px solid gray; padding: 3px 10px;">attr_1</td>
<td style="border: 1px solid gray; padding: 3px 10px;">33</td>
</tr>
<tr>
<td style="border: 1px solid gray; padding: 3px 10px;">...</td>
<td style="border: 1px solid gray; padding: 3px 10px;">...</td>
<td style="border: 1px solid gray; padding: 3px 10px;">...</td>
<td style="border: 1px solid gray; padding: 3px 10px;">...</td>
</tr>
<tr>
<td style="border: 1px solid gray; padding: 3px 10px;">n</td>
<td style="border: 1px solid gray; padding: 3px 10px;">1</td>
<td style="border: 1px solid gray; padding: 3px 10px;">attr_n</td>
<td style="border: 1px solid gray; padding: 3px 10px;">any</td>
</tr>
</table>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这种模型下, ORM 层面我们考虑封装一个对操作更友好的上层操作接口, 比如:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">obj <span style="color: #000000; font-weight: bold">=</span> Entity()
obj[<span style="color: #dd1144">&#39;attr_0&#39;</span>] <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;1&#39;</span>
obj[<span style="color: #dd1144">&#39;attr_1&#39;</span>] <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;33&#39;</span>
session<span style="color: #000000; font-weight: bold">.</span>add(obj)
session<span style="color: #000000; font-weight: bold">.</span>commit()
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
实现上, 就是把对象的方法, 包装成 SQLAlchemy 的 ORM 中的对应的关系操作.
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">BaseModel</span>(declarative_base()):
    __abstract__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #999999">True</span>

<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Entity</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;entity&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    name <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)

    _attributes <span style="color: #000000; font-weight: bold">=</span> relationship(<span style="color: #dd1144">&#39;Attribute&#39;</span>,
                               collection_class<span style="color: #000000; font-weight: bold">=</span>attribute_mapped_collection(<span style="color: #dd1144">&#39;key&#39;</span>),
                               lazy<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;joined&#39;</span>, cascade<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&quot;all, delete-orphan&quot;</span>)
    attributes <span style="color: #000000; font-weight: bold">=</span> association_proxy(<span style="color: #dd1144">&#39;_attributes&#39;</span>, <span style="color: #dd1144">&#39;value&#39;</span>,
                                   creator<span style="color: #000000; font-weight: bold">=lambda</span> k, v: Attribute(key<span style="color: #000000; font-weight: bold">=</span>k, value<span style="color: #000000; font-weight: bold">=</span>v))


<span style="color: #000000; font-weight: bold">class</span> <span style="color: #445588; font-weight: bold">Attribute</span>(BaseModel):
    __tablename__ <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;attribute&#39;</span>

    <span style="color: #0086B3">id</span> <span style="color: #000000; font-weight: bold">=</span> Column(Integer, autoincrement<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>, primary_key<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    entity <span style="color: #000000; font-weight: bold">=</span> Column(Integer, ForeignKey(<span style="color: #dd1144">&#39;entity.id&#39;</span>), index<span style="color: #000000; font-weight: bold">=</span><span style="color: #999999">True</span>)
    key <span style="color: #000000; font-weight: bold">=</span> Column(Unicode(<span style="color: #009999">32</span>), server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)
    value <span style="color: #000000; font-weight: bold">=</span> Column(UnicodeText, server_default<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&#39;&#39;</span>)


<span style="color: #000000; font-weight: bold">if</span> __name__ <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;__main__&#39;</span>:
    BaseModel<span style="color: #000000; font-weight: bold">.</span>metadata<span style="color: #000000; font-weight: bold">.</span>create_all(Engine)

    session <span style="color: #000000; font-weight: bold">=</span> Session()

    entity <span style="color: #000000; font-weight: bold">=</span> Entity(name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">u&#39;哈哈&#39;</span>)
    entity<span style="color: #000000; font-weight: bold">.</span>attributes[<span style="color: #dd1144">u&#39;first&#39;</span>] <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">u&#39;abc&#39;</span>
    entity<span style="color: #000000; font-weight: bold">.</span>attributes[<span style="color: #dd1144">u&#39;sec&#39;</span>] <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">u&#39;hoho&#39;</span>
    session<span style="color: #000000; font-weight: bold">.</span>add(entity)
    session<span style="color: #000000; font-weight: bold">.</span>commit()

    entity <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Entity)<span style="color: #000000; font-weight: bold">.</span>first()
    <span style="color: #000000; font-weight: bold">print</span> entity<span style="color: #000000; font-weight: bold">.</span>attributes
    <span style="color: #000000; font-weight: bold">del</span> entity<span style="color: #000000; font-weight: bold">.</span>attributes[<span style="color: #dd1144">&#39;first&#39;</span>]
    session<span style="color: #000000; font-weight: bold">.</span>commit()

    entity <span style="color: #000000; font-weight: bold">=</span> session<span style="color: #000000; font-weight: bold">.</span>query(Entity)<span style="color: #000000; font-weight: bold">.</span>first()
    <span style="color: #000000; font-weight: bold">print</span> entity<span style="color: #000000; font-weight: bold">.</span>attributes
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
实现上就两点:
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">_attributes</code> 关系中, 指定 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">collection_class</code> , 于是就可以得到一个像 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">dict</code> 的属性对象了.
</li>
<li style="margin: 10px auto;"><code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">association_proxy</code> 从 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">dict</code> 的属性对象中只抽出我们关心的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">value</code> 属性值.
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这个场景中, 还可以再进一步, 在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Entity</code> 类上实现 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">dict</code> 的一些方法, 直接操作其 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">attributes</code> 属性, <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">association_proxy</code> 就直接返回 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Entity</code> 的实例, 这样代码可以变成这样:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">entity <span style="color: #000000; font-weight: bold">=</span> Entity(name<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">u&#39;ABC&#39;</span>)
entity[<span style="color: #dd1144">u&#39;first&#39;</span>] <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">u&#39;a&#39;</span>
entity[<span style="color: #dd1144">u&#39;sec&#39;</span>] <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">u&#39;hoho&#39;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<style type="text/css">
body.z { background-color: #eff3fa; }
body.z > .content { background-color: white; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); }
body.z > .content > h1 { background-color: #0184b7; color: white; border-bottom: none; padding-left: 10px; border-radius: 5px; text-shadow: 0 2px 5px rgba(0, 0, 0, 0.9); }
body.z > .content > .toc a:hover { background-color: #ddd; }
body.z > .content > table th { background-color: rgba(223, 151, 27, 0.3);}
body.z > .content > .quote:before { content: '引'; font-size: 30px; color: #ddd; font-family: "'Microsoft YaHei','WenQuanYi Micro Hei',SimHei,tahoma,sans-serif"; }
body.z > .content ul > li, body.z > .content ol > li  { text-indent: -1em; }
body.z > .content  > .toc ul > li, body.z > .content  > .toc ol > li  { text-indent: 0; }
</style>
    

<script type="text/javascript" src="http://s.zys.me/js/jq/jquery.min.js"></script>
<script type="text/javascript">

$(function(){
    function bind_scroll(){
        $('body.z > .content > .toc ol').css({listStyle: 'none'})
        $('body.z > .content > .toc ul').css({listStyle: 'none'})
        $('body.z > .content > .toc a').css({display: 'block', paddingLeft: '10px'})

        var anchor_list = $.map($('.anchor'), function(n){
            return $(n).offset().top;
        });
        var item = $('body.z > .content > .toc a');
        var last = 0;
        var flag = 0;

        $(window).on('scroll', function(eventObj){
            _set_item();
        });

        function set_item(){
            var top = $(window).scrollTop();
            if(top < anchor_list[0]){
                item.eq(last).css({backgroundColor: '', color: '#0184b7'});
                last = 0;
                return;
            }

            for(var i = 0, l = anchor_list.length; i < l; i++){
                if(top < anchor_list[i]){break}
                flag = i;
            }
            item.eq(last).css({backgroundColor: '', color: '#0184b7'});
            item.eq(flag).css({backgroundColor: '#ddd', color: '#333'});
            last = flag;
        }

        var timer = null;
        function _set_item(){
            if(timer){
                clearTimeout(timer);
            }
            timer = setTimeout(set_item, 100);
        }
    }

    function create_toc(){
        if($('body.z > .content > .toc').length == 0){
            $('body.z > .content > .header').css('min-height', '200px');
            return;
        }
        if($('body.z > .content > .toc').height() < 50){return}

        //至少200空间
        var space = ($(window).width() - $('body.z > .content').outerWidth());
        if( space < 200 ){return}

        $('body.z > .content > .header').css('min-height', '200px');

        var toc_width = (space > 400 ? 400 : space);
        var content_left = (space - toc_width - 20) / 2;

        $('body.z > .content > .toc ol').css({
            paddingLeft: '20px'
        });
        $('body.z > .content > .toc ul').css({
            paddingLeft: '20px'
        });

        $('body.z > .content').css({
            marginLeft: content_left + 'px'
        });

        $('body.z > .content > .toc').css({
            fontSize: '12px',
            width: toc_width + 'px',
            backgroundColor: 'white',
            border: '1px solid #ccc',
            boxShadow: '0 2px 5px rgba(0, 0, 0, 0.3)',
            position: 'fixed',
            zIndex: 9999,
            padding: '10px',
            boxSizing: 'border-box',
            top: '50px',
            right: content_left + 'px',
            overflow: 'auto',
            maxHeight: $(window).height() - 100 + 'px'
        });

        bind_scroll();
    }

    function is_mobile(){
        if(window.devicePixelRatio > 1 || navigator.userAgent.indexOf('Android') >= 0){
            return true;
        }
        return false;
    }

    function mobile_meta(){
        var ua=navigator.userAgent;
        var meta = '';
        if(ua.indexOf('Android')!=-1){
            var isUC= /UC /.test(ua) || /UCBrowser/.test(ua) || /baidubrowser/.test(ua)|| /qq/i.test(ua);
            if(isUC){
                meta='<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,target-densitydpi=device-dpi,user-scalable=no" />';
            } else {
                meta='<meta name="viewport" content="width=device-width, initial-scale=0.5, maximum-scale=0.5,target-densitydpi=320,user-scalable=no" />';
            }
        }else{
            meta='<meta name="viewport" content="width=device-width, initial-scale=0.5, maximum-scale=0.5,target-densitydpi=device-dpi,user-scalable=no,minimal-ui" />';
        }
        $('head').append(meta);
    }

    function mobile_adjust(){
        $('body.z > .content').css({ width: '100%', padding: '15px' });
        $('#qr').hide();
        $('#disqus_thread').css({ width: '100%' });
        $('body.z').css({ letterSpacing: 0 });
        $('body.z p, body.z ul, body.z ol').css({ lineHeight: '1.5em' });
        $('body.z ul > li, body.z ol > li').css({ textIndent: '-2em' });
        $('body.z > .content > .toc ul > li, body.z > .content > .toc ol > li').css({ textIndent: 0, margin: 0 });
        $('body.z pre').css({ whiteSpace: 'pre-wrap', wordWrap: 'break-word' });
    }

    function normal_adjust(){
        $('body.z > .content > .toc ul > li, body.z > .content > .toc ol > li').css({ textIndent: 0, margin: 0 });
    }

    function code_view(){

        $('pre').click(function(eventObj){
            var $node = $($.clone(this));
            $node.attr('style', '');
            $node.css({
                fontSize: '24px',
                fontFamily: 'monospace',
                whiteSpace: 'pre-wrap',
                wordWrap: 'break-word',
                lineHeight: '1.5em',
                width: $(window).height(),
                height: $(window).width(),
                boxSizing: 'border-box',
                padding: '10px',
                paddingBottom: '30px',
                overflow: 'hidden'
            });
            var $wrapper = $('<div></div>').css({
                position: 'fixed',
                padding: 0,
                margin: 0,
                boxSizing: 'border-box',
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                width: $(window).height(),
                height: $(window).width(),
                overflow: 'hidden',
                top: ($(window).height() - $(window).width()) / 2,
                left: ($(window).width() - $(window).height()) / 2,
                transform: 'rotate(90deg)',
                zIndex: 999999
            });

            var $close = $('<div>&times;</div>').css({
                position: 'absolute',
                right: 0,
                top: 0,
                width: '100px',
                height: '100px',
                lineHeight: '80px',
                fontSize: '80px',
                textAlign: 'center',
                backgroundColor: 'rgba(204, 204, 204, 0.5)'
            });

            var $up = $('<div>△</div>').css({
                position: 'absolute',
                right: 0,
                bottom: '300px',
                width: '100px',
                height: '100px',
                lineHeight: '50px',
                fontSize: '50px',
                textAlign: 'center',
                backgroundColor: 'rgba(204, 204, 204, 0.5)',
                userSelect: 'none',
                '-webkit-user-select': 'none'
            });

            var $down = $('<div>▽</div>').css({
                position: 'absolute',
                right: 0,
                bottom: '100px',
                width: '100px',
                height: '100px',
                lineHeight: '150px',
                fontSize: '50px',
                textAlign: 'center',
                backgroundColor: 'rgba(204, 204, 204, 0.5)',
                userSelect: 'none',
                '-webkit-user-select': 'none'
            });

            $wrapper.append($node);
            $wrapper.append($close);
            $wrapper.append($up);
            $wrapper.append($down);

            $wrapper.on('touchstart', function(){
                return false;
            });

            $close.on('touchstart', function(){
                $close.css({ backgroundColor: '#0184b7' });
                return false;
            });
            $close.on('touchend', function(){

                $wrapper.off('touchend');
                $close.off('touchstart');
                $close.off('touchend');
                $up.off('touchstart');
                $up.off('touchend');
                $down.off('touchstart');
                $down.off('touchend');
                $wrapper.remove();

                return false;
            });

            var up_timer = null;
            $up.on('touchstart', function(eventObj){
                var start = $node.scrollTop();
                var dx = 0;
                $up.css({ backgroundColor: '#0184b7' });
                up_timer = setInterval(function(){
                    dx += 20;
                    $node.scrollTop(start - dx);
                }, 25);
                return false;
            });
            $up.on('touchend', function(eventObj){
                if(up_timer){clearInterval(up_timer)};
                $up.css({ backgroundColor: 'rgba(204, 204, 204, 0.5)' });
                return false;
            });

            var down_timer = null;
            $down.on('touchstart', function(eventObj){
                var start = $node.scrollTop();
                var dx = 0;
                $down.css({ backgroundColor: '#0184b7' });
                down_timer = setInterval(function(){
                    dx += 20;
                    $node.scrollTop(start + dx);
                }, 25);
                return false;
            });
            $down.on('touchend', function(eventObj){
                if(down_timer){clearInterval(down_timer)};
                $down.css({ backgroundColor: 'rgba(204, 204, 204, 0.5)' });
                return false;
            });

            $(this).before($wrapper);
        });
    
    }

    if(is_mobile()){
        mobile_meta();
        mobile_adjust();
        code_view();
    } else {
        create_toc();
        normal_adjust();
    }
});
</script>
    

    <div style="padding: 4px; line-height: 1.4em; font-size: 22px; margin-top: 100px; margin-bottom: 20px; clear: both; text-align: center; font-weight: bold; ">评论</div>
<div id="disqus_thread" style="width: 800px; margin: auto; "></div>
<script type="text/javascript">
  var disqus_shortname = 'zys';
  var disqus_identifier = 'sqlalchemy';
  var disqus_url = 'http://zouyesheng.com/sqlalchemy.html';
  var disqus_title = 'SQLAlchemy参考';

  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>评论功能需要javascript的支持</noscript>
    

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29492100-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
    

<div id="qr" style="position: absolute; right: 30px; top: 80px;"><img style="border: 1px solid gray;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKUAAAClAQAAAAAVUAB3AAABqUlEQVR4nN2XMa7bMBBE334ZoDs6
J6BOYiV3SinEShwg1yLti1A3oKrIAK1J8d19pzOLhAUBTjGDGe5iSRMf1+3tCQj/HprMbJ8OzLBY
b2bWN1QzSQwFuPiKk2pTx4v1XPjewzJBsql5vjp0ea/g8ot5/4IuE7cv5d63VUNJktt8RRsEJ9Ww
tvMmM+M6T2F/LSM3s11Lb5KkzZ/lIt37qZk3FOnkkiSgy4qM7ZJEkVNW9JKLANby3pBUA4MkRUaw
0rVMMml6bCojir6htx0s0v734Wu246XT7dtyzs1mAEpSXofSZUzn7KSpaZX4iktlxEXARWirNgVt
vgYG1bAOOrerkjeOS2V/WVxaWaaZy6t4ny5tXnk9MoZ1KCNS+w5wKgTglDlyapokXV6GUOHIvVcq
L+J9jupw7/fwc9YPwOzQUO0xAyIjSqpBsXEHAG4DtPkpuOibdoBJwspJ2FxZrdzbvfBQKgS3+Rrc
5ivQMskHep133LryK7+PnfYvvKRtmcLtVF7J+xH1yuCnYJ+59yi43ExthwyclXvv4sLs4qeX8D5H
7T/+Uf0B1AkR6iuwKmAAAAAASUVORK5CYII=
" title="本文二维码网址" /></div>
    

<div style="font-size: 10px; text-align: right; margin-top: 50px; letter-spacing: 0;">
&copy;2010-2015 zouyesheng.com All rights reserved. Powered by <a href="https://github.com/" target="_blank">GitHub</a> , <a href="http://txt2tags.org/" target="_blank">txt2tags</a> , <a href="http://www.mathjax.org/" target="_blank">MathJax</a>
</div>
    
<!-- xhtml code generated by txt2tags 2.6 (http://txt2tags.org) -->
</div></body></html>
